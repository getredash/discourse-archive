<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="../../css/checklist_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_theme_2_be4cb2b86ec06123c5e974acd20fd933d14b129d.css" rel="stylesheet"/>
<link href="../../css/discourse-adplugin_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-akismet_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-cakeday_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-chat-integration_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-details_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-footnote_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-lazy-videos_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-local-dates_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/color_definitions_base__2_8fd59ae1f286f43b3ff17996df07ea951685249d.css" rel="stylesheet"/>
<link href="../../css/style.css" rel="stylesheet"/>
<title>Upgrade from Version 2 to 4 breaks SAML authenticaion</title></head>
<body>
<div class="navbar">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<div class="navbar-buttons">
<button class="btn btn-signup">Sign Up</button>
<button class="btn btn-login"><i class="fas fa-user"></i> Login</button>
<button class="btn btn-search"><i class="fas fa-search"></i></button>
<div class="navbar-toggle">
<div class="dots"></div>
<div class="dots"></div>
<div class="dots"></div>
</div>
</div>
</div>
<div class="sidebar">
<div class="sidebar-content">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<ul class="sidebar-grid">
<!-- <li><a href="#"><i class="fas fa-list-ul"></i> Topics</a></li> -->
<li><a href="../../page_0.html"><i class="fas fa-layer-group"></i> Topics</a></li>
<li><a href="../../users.html"><i class="fas fa-users"></i> Users</a></li>
<li><a href="../../about.html"><i class="fas fa-info-circle"></i> About</a></li>
<li><a href="../../faq.html"><i class="fas fa-question-circle"></i> FAQ</a></li>
<li><a href="../../groups.html"><i class="fas fa-users"></i> Groups</a></li>
<li><a href="../../badges.html"><i class="fas fa-certificate"></i> Badges</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#categories"><span>▼</span>Categories</a></h3>
<hr/>
<ul class="sidebar-grid categories">
<li>
<a class="badge-wrapper bullet" href="../../c/support/6.html">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name">Support</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/feature-requests/5.html">
<span class="badge-category-bg" style="background-color: #3AB54A"></span>
<span class="badge-category clear-badge">
<span class="category-name">Feature Requests</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/uncategorized/1.html">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name">Uncategorized</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/development/7.html">
<span class="badge-category-bg" style="background-color: #8C6238"></span>
<span class="badge-category clear-badge">
<span class="category-name">Development</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/tips-tricks-query-examples/11.html">
<span class="badge-category-bg" style="background-color: #652D90"></span>
<span class="badge-category clear-badge" style="white-space: normal;">
<span class="category-name">Tips, Tricks &amp; Query Examples</span>
</span>
</a>
</li>
<li><a href="../../categories.html"><i class="fas fa-list-ul"></i> All categories</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#tags"><span>▼</span>Tags</a></h3>
<hr/>
<ul class="sidebar-grid tags">
<li><a href="../../tag/query_results.html"><i class="fas fa-tag"></i> query_results</a></li>
<li><a href="../../tag/feature-request.html"><i class="fas fa-tag"></i> feature-request</a></li>
<li><a href="../../tag/parameters.html"><i class="fas fa-tag"></i> parameters</a></li>
<li><a href="../../tag/visualizations.html"><i class="fas fa-tag"></i> visualizations</a></li>
<li><a href="../../tag/alerts.html"><i class="fas fa-tag"></i> alerts</a></li>
<li><a href="../../tags.html"><i class="fas fa-list-ul"></i> All tags</a></li>
</ul>
</div>
<div class="sidebar-footer">
            © 2023 <a href="https://discuss.redash.io/" target="_blank">discuss.redash.io</a>
</div>
</div>
<div class="overlay"></div>
<div class="content">
<div class="global-notice">
<div class="row">
<div class="alert alert-info alert-read-only" id="global-notice-alert-read-only">
<span class="text">This site is in read only mode. Please continue to browse, but replying, likes,
                        and other actions are disabled for now.</span>
</div>
</div>
</div>
<div class="imported_page" id="imported_page">
<div class="wrap" id="main-outlet" role="main">
<div id="topic-title">
<h1>
<a href="/t/upgrade-from-version-2-to-4-breaks-saml-authenticaion/1993">Upgrade from Version 2 to 4 breaks SAML authenticaion</a>
</h1>
<div class="topic-category" itemscope="" itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/support/6.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Support</span>
</span>
</a>
<meta content="1" itemprop="position"/>
</span>
</div>
</div>
<div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
<meta content="Upgrade from Version 2 to 4 breaks SAML authenticaion" itemprop="headline"/>
<meta content="Support" itemprop="articleSection"/>
<meta content="" itemprop="keywords"/>
<div itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
<meta content="Redash Discourse" itemprop="name"/>
<div itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject">
<meta content="https://global.discourse-cdn.com/standard17/uploads/redash1/original/1X/c07bc573841e1e4a0013ea3b6fe088a1534228a3.png" itemprop="url"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_1">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/mattdj.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/mattdj_avatar.png" tabindex="-1" width="48"/><span itemprop="name">mattdj</span></a>
</span>
<link href="https://discuss.redash.io/t/upgrade-from-version-2-to-4-breaks-saml-authenticaion/1993" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2018-06-06T02:46:11Z" itemprop="datePublished">
                    June 6, 2018,  2:46am
                  </time>
<meta content="2018-06-06T02:46:11Z" itemprop="dateModified"/>
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>Hi</p>
<p>We’ve been trying to upgrade from v2 to the latest redash.4.0.1.b4038</p>
<p>After the upgrade is complete our SAML authentication stops working, the logs in the application that handles the authentication indicate the login was successful, but the redash app throws an error:</p>
<p>[2018-06-05 23:28:44,984][PID:12168][ERROR][redash] Exception on /saml/callback [POST]<br/>
Traceback (most recent call last):<br/>
File “/usr/local/lib/python2.7/dist-packages/flask/app.py”, line 1988, in wsgi_app<br/>
response = self.full_dispatch_request()<br/>
File “/usr/local/lib/python2.7/dist-packages/flask/app.py”, line 1641, in full_dispatch_request<br/>
rv = self.handle_user_exception(e)<br/>
File “/usr/local/lib/python2.7/dist-packages/flask_restful/<strong>init</strong>.py”, line 271, in error_router<br/>
return original_handler(e)<br/>
File “/usr/local/lib/python2.7/dist-packages/flask/app.py”, line 1544, in handle_user_exception<br/>
reraise(exc_type, exc_value, tb)<br/>
File “/usr/local/lib/python2.7/dist-packages/flask/app.py”, line 1639, in full_dispatch_request<br/>
rv = self.dispatch_request()<br/>
File “/usr/local/lib/python2.7/dist-packages/flask/app.py”, line 1625, in dispatch_request<br/>
return self.view_functions<a>rule.endpoint</a><br/>
File “/opt/redash/redash.4.0.1.b4038/redash/authentication/saml_auth.py”, line 73, in idp_initiated<br/>
authn_response.get_identity()</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_2" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/mattdj.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/mattdj_avatar.png" tabindex="-1" width="48"/><span itemprop="name">mattdj</span></a>
</span>
<link href="https://discuss.redash.io/t/upgrade-from-version-2-to-4-breaks-saml-authenticaion/1993" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2018-06-07T01:45:24Z" itemprop="datePublished">
                    June 7, 2018,  1:45am
                  </time>
<meta content="2018-06-07T01:45:24Z" itemprop="dateModified"/>
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Also, the documentation around SAML doesn’t seem to be there anymore. Are there any docs anywhere?</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_3" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/machinanette.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/machinanette_avatar.png" tabindex="-1" width="48"/><span itemprop="name">machinanette</span></a>
</span>
<link href="https://discuss.redash.io/t/upgrade-from-version-2-to-4-breaks-saml-authenticaion/1993" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2018-08-03T07:01:33Z" itemprop="datePublished">
                    August 3, 2018,  7:01am
                  </time>
<meta content="2018-08-03T07:01:33Z" itemprop="dateModified"/>
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I also had the same problem when I upgrade from v3 to v4.<br/>
In my case, I solved it by changing the callback.</p>
<p>ver3 callback<br/>
<a class="onebox" href="https://xxxxxxxxxxxxxxx/saml/callback" rel="nofollow noopener" target="_blank">https://xxxxxxxxxxxxxxx/saml/callback</a></p>
<p>ver4 callback<br/>
<a class="onebox" href="https://xxxxxxxxxxxxxxx/saml/callback?org_slug=default" rel="nofollow noopener" target="_blank">https://xxxxxxxxxxxxxxx/saml/callback?org_slug=default</a></p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="2" itemprop="userInteractionCount"/>
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_4" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/raj.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/raj_avatar.png" tabindex="-1" width="48"/><span itemprop="name">raj</span></a>
</span>
<link href="https://discuss.redash.io/t/upgrade-from-version-2-to-4-breaks-saml-authenticaion/1993" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2019-03-26T03:45:49Z" itemprop="datePublished">
                    March 26, 2019,  3:45am
                  </time>
<meta content="2019-03-26T21:28:26Z" itemprop="dateModified"/>
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I am using Redash native docker based setup and tried to upgrade from v6 to v7 today and had the same issue. SAML OKTA broke and gave me an error 500 internal server error.<br/>
I am using the okta URL <a href="https://xxxxxxxxxxxxxxx/saml/callback?org_slug=default" rel="nofollow noopener">https://xxxxxxxxxxxxxxx/saml/callback?org_slug=default</a><br/>
I am using external RDS database , so I didn’t run the db upgrade command during the upgrade process.</p>
<h2>Upgrade Process followed per documentation</h2>
<ol>
<li>Make sure to backup your data. You only need to backup Redash’s PostgreSQL database (the database Redash stores metadata in, not the ones you might be querying) as the data in Redis is transient.</li>
<li>Update  <code>/opt/redash/docker-compose.yml</code>  Redash image reference to the one you want to upgrade to.</li>
<li>Stop Redash services:  <code>docker-compose stop server scheduler scheduled_worker adhoc_worker</code>  (you might need to list additional services if you updated your configuration)</li>
<li>Apply migration (if necessary):  <code>docker-compose run --rm server manage db upgrade</code>
</li>
<li>Start services:  <code>docker-compose up -d</code>
</li>
</ol>
<p>I got the similar error in container logs:<br/>
[2019-03-26 18:19:40,139][PID:126][ERROR][redash] Exception on /saml/callback [POST]<br/>
Traceback (most recent call last):<br/>
File “/usr/local/lib/python2.7/dist-packages/flask/app.py”, line 1988, in wsgi_app<br/>
response = self.full_dispatch_request()<br/>
File “/usr/local/lib/python2.7/dist-packages/flask/app.py”, line 1641, in full_dispatch_request<br/>
rv = self.handle_user_exception(e)<br/>
File “/usr/local/lib/python2.7/dist-packages/flask_restful/<strong>init</strong>.py”, line 271, in error_router<br/>
return original_handler(e)<br/>
File “/usr/local/lib/python2.7/dist-packages/flask/app.py”, line 1544, in handle_user_exception<br/>
reraise(exc_type, exc_value, tb)<br/>
File “/usr/local/lib/python2.7/dist-packages/flask/app.py”, line 1639, in full_dispatch_request<br/>
rv = self.dispatch_request()<br/>
File “/usr/local/lib/python2.7/dist-packages/flask/app.py”, line 1625, in dispatch_request<br/>
return self.view_functions<a>rule.endpoint</a><br/>
File “/app/redash/authentication/saml_auth.py”, line 87, in idp_initiated<br/>
user = create_and_login_user(current_org, name, email)<br/>
File “/app/redash/authentication/<strong>init</strong>.py”, line 259, in create_and_login_user<br/>
user_object = models.User.get_by_email_and_org(email, org)<br/>
File “/app/redash/models/users.py”, line 183, in get_by_email_and_org<br/>
return cls.get_by_org(org).filter(cls.email == email).one()<br/>
File “/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/query.py”, line 2954, in one<br/>
ret = self.one_or_none()<br/>
File “/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/query.py”, line 2924, in one_or_none<br/>
ret = list(self)<br/>
File “/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/query.py”, line 2995, in <strong>iter</strong><br/>
return self._execute_and_instances(context)<br/>
File “/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/query.py”, line 3018, in _execute_and_instances<br/>
result = conn.execute(querycontext.statement, self._params)<br/>
File “/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py”, line 948, in execute<br/>
return meth(self, multiparams, params)<br/>
File “/usr/local/lib/python2.7/dist-packages/sqlalchemy/sql/elements.py”, line 269, in _execute_on_connection<br/>
return connection._execute_clauseelement(self, multiparams, params)<br/>
File “/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py”, line 1060, in _execute_clauseelement<br/>
compiled_sql, distilled_params<br/>
File “/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py”, line 1200, in _execute_context<br/>
context)<br/>
File “/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py”, line 1413, in _handle_dbapi_exception<br/>
exc_info<br/>
File “/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/compat.py”, line 265, in raise_from_cause<br/>
reraise(type(exception), exception, tb=exc_tb, cause=cause)<br/>
File “/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py”, line 1193, in _execute_context<br/>
context)<br/>
File “/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/default.py”, line 509, in do_execute<br/>
cursor.execute(statement, parameters)<br/>
ProgrammingError: (psycopg2.ProgrammingError) column users.details does not exist<br/>
LINE 1: …_api_key, users.disabled_at AS users_disabled_at, users.deta…<br/>
^<br/>
HINT:  Perhaps you meant to reference the column “users.email”.<br/>
[SQL: ‘SELECT users.profile_image_url AS users_profile_image_url, users.groups AS users_groups, users.updated_at AS users_updated_at, users.created_at AS users_created_at, users.id AS users_id, users.org_id AS users_org_id, users.name AS users_name, users.email AS users_email, users.password_hash AS users_password_hash, users.api_key AS users_api_key, users.disabled_at AS users_disabled_at, users.details AS users_details \nFROM users \nWHERE %(param_1)s = users.org_id AND users.email = lower(%(lower_1)s)’] [parameters: {‘lower_1’: ‘nagaraju.balusa@disqo.com’, ‘param_1’: 1}] (Background on this error at: <a href="http://sqlalche.me/e/f405" rel="nofollow noopener">http://sqlalche.me/e/f405</a>)<br/>
[2019-03-26 18:19:40,140][PID:126][INFO][metrics] method=POST path=/saml/callback endpoint=saml_auth_idp_initiated status=500 content_type=? content_length=-1 duration=182.67 query_count=1 query_duration=3.20</p>
<p>When I rollback to v6 the saml works fine and authenticates me.<br/>
Does anyone have issues upgrading to v7 too.?<br/>
Can anyone help if they did resolve this issue?</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="overlay" id="modalOverlay" style="display: none;">
<div class="modal-content">
<p>Login or sign up disabled while the site is in read only mode</p>
<hr/>
<button class="btn btn-login">OK</button>
</div>
</div>
<script src="../../js/script.js"></script>
</body>
</html>