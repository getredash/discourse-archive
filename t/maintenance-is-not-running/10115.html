<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="../../css/checklist_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_theme_2_be4cb2b86ec06123c5e974acd20fd933d14b129d.css" rel="stylesheet"/>
<link href="../../css/discourse-adplugin_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-akismet_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-cakeday_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-chat-integration_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-details_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-footnote_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-lazy-videos_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-local-dates_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/color_definitions_base__2_8fd59ae1f286f43b3ff17996df07ea951685249d.css" rel="stylesheet"/>
<link href="../../css/style.css" rel="stylesheet"/>
<title>Maintenance is not running</title></head>
<body>
<div class="navbar">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<div class="navbar-buttons">
<button class="btn btn-signup">Sign Up</button>
<button class="btn btn-login"><i class="fas fa-user"></i> Login</button>
<button class="btn btn-search"><i class="fas fa-search"></i></button>
<div class="navbar-toggle">
<div class="dots"></div>
<div class="dots"></div>
<div class="dots"></div>
</div>
</div>
</div>
<div class="sidebar">
<div class="sidebar-content">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<ul class="sidebar-grid">
<!-- <li><a href="#"><i class="fas fa-list-ul"></i> Topics</a></li> -->
<li><a href="../../page_0.html"><i class="fas fa-layer-group"></i> Topics</a></li>
<li><a href="../../users.html"><i class="fas fa-users"></i> Users</a></li>
<li><a href="../../about.html"><i class="fas fa-info-circle"></i> About</a></li>
<li><a href="../../faq.html"><i class="fas fa-question-circle"></i> FAQ</a></li>
<li><a href="../../groups.html"><i class="fas fa-users"></i> Groups</a></li>
<li><a href="../../badges.html"><i class="fas fa-certificate"></i> Badges</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#categories"><span>▼</span>Categories</a></h3>
<hr/>
<ul class="sidebar-grid categories">
<li>
<a class="badge-wrapper bullet" href="../../c/support/6.html">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name">Support</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/feature-requests/5.html">
<span class="badge-category-bg" style="background-color: #3AB54A"></span>
<span class="badge-category clear-badge">
<span class="category-name">Feature Requests</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/uncategorized/1.html">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name">Uncategorized</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/development/7.html">
<span class="badge-category-bg" style="background-color: #8C6238"></span>
<span class="badge-category clear-badge">
<span class="category-name">Development</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/tips-tricks-query-examples/11.html">
<span class="badge-category-bg" style="background-color: #652D90"></span>
<span class="badge-category clear-badge" style="white-space: normal;">
<span class="category-name">Tips, Tricks &amp; Query Examples</span>
</span>
</a>
</li>
<li><a href="../../categories.html"><i class="fas fa-list-ul"></i> All categories</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#tags"><span>▼</span>Tags</a></h3>
<hr/>
<ul class="sidebar-grid tags">
<li><a href="../../tag/query_results.html"><i class="fas fa-tag"></i> query_results</a></li>
<li><a href="../../tag/feature-request.html"><i class="fas fa-tag"></i> feature-request</a></li>
<li><a href="../../tag/parameters.html"><i class="fas fa-tag"></i> parameters</a></li>
<li><a href="../../tag/visualizations.html"><i class="fas fa-tag"></i> visualizations</a></li>
<li><a href="../../tag/alerts.html"><i class="fas fa-tag"></i> alerts</a></li>
<li><a href="../../tags.html"><i class="fas fa-list-ul"></i> All tags</a></li>
</ul>
</div>
<div class="sidebar-footer">
            © 2023 <a href="https://discuss.redash.io/" target="_blank">discuss.redash.io</a>
</div>
</div>
<div class="overlay"></div>
<div class="content">
<div class="global-notice">
<div class="row">
<div class="alert alert-info alert-read-only" id="global-notice-alert-read-only">
<span class="text">This site is in read only mode. Please continue to browse, but replying, likes,
                        and other actions are disabled for now.</span>
</div>
</div>
</div>
<div class="imported_page" id="imported_page">
<div class="wrap" id="main-outlet" role="main">
<div id="topic-title">
<h1>
<a href="/t/maintenance-is-not-running/10115">Maintenance is not running</a>
</h1>
<div class="topic-category" itemscope="" itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/support/6.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Support</span>
</span>
</a>
<meta content="1" itemprop="position"/>
</span>
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/support/support-self-hosted/9.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Self Hosted Redash Support</span>
</span>
</a>
<meta content="2" itemprop="position"/>
</span>
</div>
</div>
<div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
<meta content="Maintenance is not running" itemprop="headline"/>
<meta content="Self Hosted Redash Support" itemprop="articleSection"/>
<meta content="" itemprop="keywords"/>
<div itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
<meta content="Redash Discourse" itemprop="name"/>
<div itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject">
<meta content="https://global.discourse-cdn.com/standard17/uploads/redash1/original/1X/c07bc573841e1e4a0013ea3b6fe088a1534228a3.png" itemprop="url"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_1">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/kirkiris.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/kirkiris_avatar.png" tabindex="-1" width="48"/><span itemprop="name">kirkiris</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-03-09T16:42:41Z" itemprop="datePublished">
                    March 9, 2022,  4:42pm
                  </time>
<meta content="2022-03-09T16:42:41Z" itemprop="dateModified"/>
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<h3>
<a class="anchor" href="#issue-summary-1" name="issue-summary-1"></a>Issue Summary</h3>
<p>Hello everyone,</p>
<p>We noticed that after upgrading Redash to v10 (from v8), the job to cleanup unused query results does not seem to be running.</p>
<p>As a result, the free space in Redash’s database gets depleted and we need to scale it up in order to keep the service up and running.</p>
<p>Any ideas what may be going wrong here?</p>
<p>Cheers,<br/>
Theodore</p>
<h3>
<a class="anchor" href="#technical-details-2" name="technical-details-2"></a>Technical details:</h3>
<ul>
<li>Redash Version: 10.1.0</li>
<li>How did you install Redash: Using the <a href="https://github.com/getredash/setup" rel="noopener nofollow ugc">setup script</a> to deploy v8. Then upgraded to v10 following the instructions provided in the <a href="https://github.com/getredash/redash/releases/v10.1.0" rel="noopener nofollow ugc">release notes</a>
</li>
</ul>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_2" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/jesse.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/jesse_avatar.png" tabindex="-1" width="48"/><span itemprop="name">jesse</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-03-11T20:03:52Z" itemprop="datePublished">
                    March 11, 2022,  8:03pm
                  </time>
<meta content="2022-03-11T20:03:52Z" itemprop="dateModified"/>
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Welcome to the user forum and sorry for this late reply.</p>
<p>There are a few possible causes for this issue:</p>
<ol>
<li>The periodic cleanup job is not being scheduled</li>
<li>The job is being scheduled but no worker processes will run it</li>
<li>The job is scheduled and acquired by a worker but fails</li>
</ol>
<p>Most of the time the first one is the culprit.</p>
<p>Can you check that at least one of your worker processes is monitoring the <code>periodic</code> jobs queue?</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="2" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_3" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/jesse.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/jesse_avatar.png" tabindex="-1" width="48"/><span itemprop="name">jesse</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-03-11T20:11:07Z" itemprop="datePublished">
                    March 11, 2022,  8:11pm
                  </time>
<meta content="2022-03-11T20:11:07Z" itemprop="dateModified"/>
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Related <a class="inline-onebox" href="http://discuss.redash.io/t/high-disk-size-issue-with-redash-postgres/9859">High Disk Size issue with Redash Postgres</a></p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_4" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/kirkiris.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/kirkiris_avatar.png" tabindex="-1" width="48"/><span itemprop="name">kirkiris</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-03-14T09:10:21Z" itemprop="datePublished">
                    March 14, 2022,  9:10am
                  </time>
<meta content="2022-03-14T09:10:21Z" itemprop="dateModified"/>
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hi Jesse,</p>
<p>Thank you for your reply.</p>
<blockquote>
<p>Most of the time the first one is the culprit.</p>
</blockquote>
<p>This is my understanding as well. I believe if either 2 or 3 were the case, it would appear in the logs.</p>
<blockquote>
<p>Can you check that at least one of your worker processes is monitoring the <code>periodic</code> jobs queue?</p>
</blockquote>
<p>It does. We have followed the instructions provided <a href="https://github.com/getredash/redash/releases/v10.0.0" rel="noopener nofollow ugc">here</a> to add a new service for general RQ jobs and our configuration is almost identical to the one in step <code>5</code> (please see below). Emails and tasks in the default queue are executed normally.</p>
<pre><code class="lang-auto">  worker:
    &lt;&lt;: *redash-service
    command: worker
    mem_limit: 3000m
    environment:
      QUEUES: "periodic emails default"
      WORKERS_COUNT: 25
</code></pre>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_5" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/kirkiris.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/kirkiris_avatar.png" tabindex="-1" width="48"/><span itemprop="name">kirkiris</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-03-14T09:20:12Z" itemprop="datePublished">
                    March 14, 2022,  9:20am
                  </time>
<meta content="2022-03-14T09:20:12Z" itemprop="dateModified"/>
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Following up on <a href="http://discuss.redash.io/t/high-disk-size-issue-with-redash-postgres/9859">High Disk Size issue with Redash Postgres</a>:</p>
<p><code>REDASH_QUERY_RESULTS_CLEANUP_ENABLED</code> env var has not been set to false.</p>
<p>We have set the following though to mitigate the issue and clean up the database</p>
<pre><code class="lang-auto">REDASH_QUERY_RESULTS_CLEANUP_MAX_AGE=1
REDASH_QUERY_RESULTS_CLEANUP_COUNT=200
</code></pre>
<p>but to no avail. Task scheduling is not consistent.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_6" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/jesse.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/jesse_avatar.png" tabindex="-1" width="48"/><span itemprop="name">jesse</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-03-15T19:04:51Z" itemprop="datePublished">
                    March 15, 2022,  7:04pm
                  </time>
<meta content="2022-03-15T19:04:51Z" itemprop="dateModified"/>
<span itemprop="position">6</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Thanks for the details. If you check your docker logs, do you see a message like this from the <code>scheduler</code> service when it starts?</p>
<pre><code class="lang-bash">[2022-03-15 17:20:25,452][PID:8][INFO][redash.tasks.schedule] Scheduling e27209059575fcc17c527c47d0957cb21756e551 (cleanup_query_results) with interval 300.
</code></pre>
<p>The interval is in seconds. So <code>300</code> here means it will run every five minutes.</p>
<p>When it runs you should see a log message from one of the <code>worker</code> services that observes the <code>periodic</code> queue. The message will look like this:</p>
<pre><code class="lang-bash">[2022-03-15 17:25:33,910][PID:25][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 Running query results clean up (removing maximum of 100 unused results, that are 0 days old or more)
</code></pre>
<p>In my case I set it to clean up all query results to make it easy to verify.</p>
<p>Do you see any messages like this?</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_7" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/kirkiris.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/kirkiris_avatar.png" tabindex="-1" width="48"/><span itemprop="name">kirkiris</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-03-16T10:45:42Z" itemprop="datePublished">
                    March 16, 2022, 10:45am
                  </time>
<meta content="2022-03-16T10:51:08Z" itemprop="dateModified"/>
<span itemprop="position">7</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I have checked the logs since Feb 21st (that’s when Redash was upgraded to v10) and here are my findings:</p>
<blockquote>
<p>If you check your docker logs, do you see a message like this from the scheduler service when it starts?</p>
</blockquote>
<p>There are only a few entries with a message like this. My understanding is that I should be expecting to see it every time the task was starting, is that correct?</p>
<details>
<summary>Show logs</summary>
<pre><code class="lang-auto">[2022-02-21 15:59:56635][PID:1][INFO][redash.tasks.schedule] Scheduling e27209059575fcc17c527c47d0957cb21756e551 (cleanup_query_results) with interval 300.
[2022-02-22 10:43:58998][PID:1][INFO][redash.tasks.schedule] Scheduling e27209059575fcc17c527c47d0957cb21756e551 (cleanup_query_results) with interval 300.
[2022-03-02 09:12:02255][PID:1][INFO][redash.tasks.schedule] Scheduling e27209059575fcc17c527c47d0957cb21756e551 (cleanup_query_results) with interval 300.
[2022-03-09 14:23:05815][PID:1][INFO][redash.tasks.schedule] Scheduling e27209059575fcc17c527c47d0957cb21756e551 (cleanup_query_results) with interval 300.
[2022-03-11 16:47:31106][PID:1][INFO][redash.tasks.schedule] Scheduling e27209059575fcc17c527c47d0957cb21756e551 (cleanup_query_results) with interval 300.
</code></pre>
</details>
<hr/>
<blockquote>
<p>Do you see any messages like this?</p>
</blockquote>
<p>Yes, but not consistently. In the beginning it was scheduled a few times but not sticking to its schedule and then it stopped.<br/>
On Mar 2nd we received an alert for high disk space utilization from the Redash database and we started looking into it.<br/>
We realized that the cleanup task wasn’t running but we couldn’t understand why, so we restarted all services and tried to clean up manually some old cached query results.</p>
<p>Since then the task was being scheduled normally as expected, up until March 8th when it stopped again (I am not posting all the logs from that time but I can do so if needed).<br/>
Since then there were only a couple of entries in the logs. We saw the task being scheduled <strong>once</strong> after restarting Redash and then again nothing.</p>
<details>
<summary>Show logs</summary>
<pre><code class="lang-auto">[2022-02-21 16:04:14,015][PID:229][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 Running query results clean up (removing maximum of 100 unused results, that are 7 days old or more)
[2022-02-21 16:04:17,031][PID:229][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 Deleted 100 unused query results.
[2022-02-22 10:48:11,001][PID:207][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 Running query results clean up (removing maximum of 100 unused results, that are 7 days old or more)
[2022-02-22 10:48:12,699][PID:207][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 Deleted 100 unused query results.
[2022-03-02 08:30:53,816][PID:4653][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=325de3b5237b058d20e318b14fbf4bee0aaf2f76 Running query results clean up (removing maximum of 100 unused results, that are 7 days old or more)
[2022-03-02 08:30:54,392][PID:4653][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=325de3b5237b058d20e318b14fbf4bee0aaf2f76 Deleted 100 unused query results.
[...]
[2022-03-08 10:18:46,643][PID:17436][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 Running query results clean up (removing maximum of 100 unused results, that are 7 days old or more)
[2022-03-08 10:18:46,948][PID:17436][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 Deleted 0 unused query results.
[2022-03-09 14:27:19,547][PID:212][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 Running query results clean up (removing maximum of 200 unused results, that are 1 days old or more
[2022-03-11 16:52:08,715][PID:219][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 Running query results clean up (removing maximum of 200 unused results, that are 1 days old or more)
[2022-03-11 16:52:11,014][PID:219][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 Deleted 200 unused query results.
</code></pre>
</details>
<hr/>
<p>I have restarted all the services a couple of times with no luck; the task still does not seem to be scheduled</p>
<p>I have tried both:</p>
<pre><code class="lang-auto">docker-compose up -d
</code></pre>
<p>and</p>
<pre><code class="lang-auto">docker-compose up -d --force-recreate --build
</code></pre>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_8" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/jesse.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/jesse_avatar.png" tabindex="-1" width="48"/><span itemprop="name">jesse</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-03-16T16:36:47Z" itemprop="datePublished">
                    March 16, 2022,  4:36pm
                  </time>
<meta content="2022-03-16T16:36:47Z" itemprop="dateModified"/>
<span itemprop="position">8</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-post="7" data-topic="10115" data-username="kirkiris">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3146_2.png" width="20"/> kirkiris:</div>
<blockquote>
<p>My understanding is that I should be expecting to see it every time the task was starting, is that correct?</p>
</blockquote>
</aside>
<p>Not quite. This message emits exactly once when the <strong>scheduler</strong> service starts, i.e when you run <code>docker-compose up -d</code>. If you ran <code>docker-compose restart scheduler</code> you should see the message again. As a debugging step, you should try restarting your scheduler and verifying that the cleanup task registration log appears.</p>
<p>That said, a <em>different</em> message will appear when the cleanup task actually runs. That different message will be emitted not by the scheduler, but by the <strong>worker</strong>.</p>
<aside class="quote no-group" data-post="7" data-topic="10115" data-username="kirkiris">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3146_2.png" width="20"/> kirkiris:</div>
<blockquote>
<p>We saw the task being scheduled <strong>once</strong> after restarting Redash and then again nothing.</p>
</blockquote>
</aside>
<p>Exactly right. This is normal. When the scheduler starts it emits logs to say which tasks it will schedule, and at what interval. The scheduler never executes tasks, it only schedules them. It does not emit a message every time it schedules a task.</p>
<p>So you might ask, “how will I know the task is running if the scheduler doesn’t tell me?”. That’s where the worker logs come in. When a worker pulls a job from the queue, it emits a log message specifying the job id, task name, and a timestamp. So in simple terms what you should expect to to see is:</p>
<p><strong>00:00 scheduler</strong>: I’m going to schedule this task to run every five minutes<br/>
<strong>00:00 worker</strong>: I just picked up a task to run, I’m doing that now<br/>
<strong>00:01 worker</strong>: I finished the task, here’s the outcome<br/>
<strong>00:05 worker</strong>: I just picked up a task to run, I’m doing that now<br/>
<strong>00:06 worker</strong>: I finished the task, here’s the outcome<br/>
<strong>00:10 worker</strong>: I just picked up a task to run, I’m doing that now<br/>
<strong>00:11 worker</strong>: I finished the task, here’s the outcome</p>
<p>…and so on.</p>
<p>One thing that may be happening is that the cleanup job is taking too long to execute. What are your settings for the number of results to cleanup and the interval?</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_9" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/kirkiris.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/kirkiris_avatar.png" tabindex="-1" width="48"/><span itemprop="name">kirkiris</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-03-17T15:24:39Z" itemprop="datePublished">
                    March 17, 2022,  3:24pm
                  </time>
<meta content="2022-03-17T15:28:43Z" itemprop="dateModified"/>
<span itemprop="position">9</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote group-Team" data-post="8" data-topic="10115" data-username="jesse">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3428_2.png" width="20"/> jesse:</div>
<blockquote>
<p>This message emits exactly once when the <strong>scheduler</strong> service starts</p>
</blockquote>
</aside>
<p>I see, thanks for clarifying this!</p>
<aside class="quote group-Team" data-post="8" data-topic="10115" data-username="jesse">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3428_2.png" width="20"/> jesse:</div>
<blockquote>
<p>As a debugging step, you should try restarting your scheduler and verifying that the cleanup task registration log appears.</p>
</blockquote>
</aside>
<p>After issuing a</p>
<pre><code class="lang-auto">docker-compose restart scheduler
</code></pre>
<p>the task seems to have both been registered and executed as expected.<br/>
Logs below are just to confirm that the task has been registered and has had 2 successful executions; other than that, I confirm that it’s been running consistently every 5 minutes, up until the time I am posting this message. It doesn’t make sense…</p>
<details>
<summary>Show logs</summary>
<pre><code class="lang-auto">[2022-03-17 10:43:44,795][pid:1][info][redash.tasks.schedule] scheduling e27209059575fcc17c527c47d0957cb21756e551 (cleanup_query_results) with interval 300.
[2022-03-17 10:43:44,812][pid:32678][info][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 running query results clean up (removing maximum of 200 unused results, that are 1 days old or more)
[2022-03-17 10:43:45,985][pid:32678][info][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 deleted 200 unused query results.
[2022-03-17 10:48:45,050][PID:360][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 Running query results clean up (removing maximum of 200 unused results, that are 1 days old or more)
[2022-03-17 10:48:45,962][PID:360][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 Deleted 200 unused query results.
</code></pre>
</details>
<hr/>
<aside class="quote group-Team" data-post="8" data-topic="10115" data-username="jesse">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3428_2.png" width="20"/> jesse:</div>
<blockquote>
<p>What are your settings for the number of results to cleanup and the interval?</p>
</blockquote>
</aside>
<p>We have set the following values in <code>/opt/redash/env</code>:</p>
<pre><code class="lang-auto">REDASH_QUERY_RESULTS_CLEANUP_MAX_AGE=1
REDASH_QUERY_RESULTS_CLEANUP_COUNT=200
</code></pre>
<p>Interval hasn’t been changed; I couldn’t find any cleanup related <a href="https://redash.io/help/open-source/admin-guide/env-vars-settings" rel="noopener nofollow ugc">env vars</a> for interval, but from <a href="https://github.com/getredash/redash/blob/e6ebef1e5ab866ce1e706eaee6260edaffdc2bd7/redash/tasks/schedule.py#L90" rel="noopener nofollow ugc">this</a> I am guessing the interval is hardcoded to 5 minutes?</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_10" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/jesse.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/jesse_avatar.png" tabindex="-1" width="48"/><span itemprop="name">jesse</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-03-17T16:12:49Z" itemprop="datePublished">
                    March 17, 2022,  4:12pm
                  </time>
<meta content="2022-03-17T16:12:49Z" itemprop="dateModified"/>
<span itemprop="position">10</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-post="9" data-topic="10115" data-username="kirkiris">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3146_2.png" width="20"/> kirkiris:</div>
<blockquote>
<p>I see, thanks for clarifying this!</p>
</blockquote>
</aside>
<p>I’m looking forward to adding this breakdown to our documentation. Thanks for your patience while I gathered the info!</p>
<aside class="quote no-group" data-post="9" data-topic="10115" data-username="kirkiris">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3146_2.png" width="20"/> kirkiris:</div>
<blockquote>
<p>but from <a href="https://github.com/getredash/redash/blob/e6ebef1e5ab866ce1e706eaee6260edaffdc2bd7/redash/tasks/schedule.py#L90">this</a> I am guessing the interval is hardcoded to 5 minutes?</p>
</blockquote>
</aside>
<p>You’re right. I didn’t read closely enough (I’m updating the docs for Redash settings right now btw).</p>
<p>It sounds like for the moment your issue is resolved. But if you haven’t changed any settings it seems likely that the issue of database bloat will continue. I wonder if the cause ultimately is that the job is running but…</p>
<p>a) it crashes or hangs midway through<br/>
b) it runs normally, but the number of results to clean up is growing faster than the cleanup job can clear it</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_11" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/kirkiris.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/kirkiris_avatar.png" tabindex="-1" width="48"/><span itemprop="name">kirkiris</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-03-17T17:24:46Z" itemprop="datePublished">
                    March 17, 2022,  5:24pm
                  </time>
<meta content="2022-03-17T17:24:46Z" itemprop="dateModified"/>
<span itemprop="position">11</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote group-Team" data-post="10" data-topic="10115" data-username="jesse">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3428_2.png" width="20"/> jesse:</div>
<blockquote>
<p>Thanks for your patience while I gathered the info!</p>
</blockquote>
</aside>
<p>Of course!</p>
<hr/>
<p>I do have some additional questions:</p>
<aside class="quote group-Team" data-post="10" data-topic="10115" data-username="jesse">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3428_2.png" width="20"/> jesse:</div>
<blockquote>
<p>I wonder if the cause ultimately is that the job is running but…</p>
</blockquote>
</aside>
<p>There was no indication in the logs that the task was running.<br/>
Instead, the logs indicate it had stopped running unexpectedly.</p>
<aside class="quote group-Team" data-post="10" data-topic="10115" data-username="jesse">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3428_2.png" width="20"/> jesse:</div>
<blockquote>
<p>a) it crashes or hangs midway through</p>
</blockquote>
</aside>
<p>I would expect to see an error in the logs, but there weren’t any. Or at least none showed up when filtering with the term: <code>cleanup_query_results</code>.</p>
<aside class="quote group-Team" data-post="10" data-topic="10115" data-username="jesse">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3428_2.png" width="20"/> jesse:</div>
<blockquote>
<p>b) it runs normally, but the number of results to clean up is growing faster than the cleanup job can clear it</p>
</blockquote>
</aside>
<p>Here I must ask: Why was there no indication in the logs that the task was running? <img alt=":thinking:" class="emoji" height="20" loading="lazy" src="assets/thinking.png" title=":thinking:" width="20"/></p>
<hr/>
<p>Now the most interesting part:</p>
<aside class="quote group-Team" data-post="10" data-topic="10115" data-username="jesse">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3428_2.png" width="20"/> jesse:</div>
<blockquote>
<p>b) it runs normally, but the number of results to clean up is growing faster than the cleanup job can clear it</p>
</blockquote>
</aside>
<p>I hear you, and I raised the number of results to be cleaned up to:</p>
<pre><code class="lang-auto">REDASH_QUERY_RESULTS_CLEANUP_COUNT=500
</code></pre>
<p>(from 200) and then I issued a:</p>
<pre><code class="lang-auto">docker-compose up -d
</code></pre>
<p>and didn’t see any logs indicating that the scheduler had scheduled the task.</p>
<p>I waited for a while and then I issued a</p>
<pre><code class="lang-auto">docker-compose restart scheduler
</code></pre>
<p>but again no logs indicating the cleanup task registration.</p>
<p><strong>Finally</strong>, after issuing another</p>
<pre><code class="lang-auto">docker-compose restart scheduler
</code></pre>
<p>I saw that the task was registered</p>
<pre><code class="lang-auto">2022-03-17 17:23:10,493][PID:1][INFO][redash.tasks.schedule] &lt;mark&gt;Scheduling&lt;/mark&gt; e27209059575fcc17c527c47d0957cb21756e551 (&lt;mark&gt;cleanup_query_results&lt;/mark&gt;) with interval 300.
</code></pre>
<p>What is going on? <img alt=":sweat:" class="emoji" height="20" loading="lazy" src="assets/sweat.png" title=":sweat:" width="20"/></p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_12" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/jesse.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/jesse_avatar.png" tabindex="-1" width="48"/><span itemprop="name">jesse</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-03-17T17:45:16Z" itemprop="datePublished">
                    March 17, 2022,  5:45pm
                  </time>
<meta content="2022-03-17T17:45:16Z" itemprop="dateModified"/>
<span itemprop="position">12</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hmmm very strange not to see the registration, although it’s possible waiting longer may have shown a result. For consistency, I never run <code>docker-compose up -d</code> on its own to restart services. I run <code>stop</code> first, like this:</p>
<pre data-code-wrap="zsh"><code class="lang-nohighlight">$ docker-compose stop &amp;&amp; docker-compose up -d
</code></pre>
<p>This guarantees that everything stops and is restarted.</p>
<p>I don’t usually run <code>docker-compose restart</code> (without specifying a service first) because this won’t guarantee that environment variable changes are propagated (not sure why, but it’s a docker issue not specific to Redash).</p>
<aside class="quote no-group" data-post="11" data-topic="10115" data-username="kirkiris">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3146_2.png" width="20"/> kirkiris:</div>
<blockquote>
<p>Here I must ask: Why was there no indication in the logs that the task was running? <img alt=":thinking:" class="emoji" height="20" loading="lazy" src="assets/thinking.png" title=":thinking:" width="20"/></p>
</blockquote>
</aside>
<p>Possible causes:</p>
<ul>
<li>It could be an insufficient number of workers monitoring the <code>periodic</code> queue. If another periodic job is hogging the workers then the cleanup task might never run. To check for this, observe how many jobs are in the periodic queue when you stop seeing the task run. If the number stays static or increases, there aren’t enough workers.</li>
<li>The worker is crashing before it can emit the log saying it’s picked up the task. To check for this, don’t grep for <code>cleanup_query_results</code>, but instead see if there are signs of a worker thread crashing.</li>
<li>The scheduler stops scheduling the job. To check for this, you can connect directly to the <code>redis</code> instance and pattern search for <code>cleanup_query_results</code> in the redis database.</li>
</ul>
<p>Depending on which of those is the cause there would be different steps to fix.</p>
<p>Not sure. Keep an eye on it and ping what you find or if you have questions. We’ll get to the bottom of it I’m sure.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
<div class="crawler-linkback-list" itemscope="" itemtype="http://schema.org/ItemList">
<div itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a href="http://discuss.redash.io/t/redash-eating-disk-space/10490/2" itemprop="url">Redash Eating Disk Space</a>
<meta content="1" itemprop="position"/>
</div>
<div itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a href="http://discuss.redash.io/t/periodic-refreshes-are-not-happening/10829/13" itemprop="url">Periodic refreshes are not happening</a>
<meta content="2" itemprop="position"/>
</div>
</div>
</div>
<div class="topic-body crawler-post" id="post_13" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/kirkiris.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/kirkiris_avatar.png" tabindex="-1" width="48"/><span itemprop="name">kirkiris</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<link href="assets/9d8c7875426a85154319ff1f3a7bc44efecbd4e5.png" itemprop="image"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-08-05T08:08:49Z" itemprop="datePublished">
                    August 5, 2022,  8:08am
                  </time>
<meta content="2022-08-05T08:08:49Z" itemprop="dateModified"/>
<span itemprop="position">13</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hello,</p>
<p>Circling back on this as the <code>cleanup_query_results</code> seems to have stopped running again.</p>
<p>Unfortunately we only noticed because we got a notification about the Redash DB running out of storage and realized it wasn’t running for the past month or so.</p>
<p>As before, the task was scheduled successfully after the service was restarted, run once, and then nothing again. Redash has been restarted a couple of times after that to see if the job will run consistently, but I am only noticing the same behavior. Gets scheduled, runs once, then nothing.</p>
<details>
<summary> Show logs </summary>
<pre><code class="lang-auto">[2022-08-05 07:11:25,916][PID:1][INFO][redash.tasks.schedule] Scheduling e27209059575fcc17c527c47d0957cb21756e551 (cleanup_query_results) with interval 300.
[2022-08-05 07:15:37,847][PID:212][INFO][rq.job.redash.tasks.queries.maintenance] job.func_name=redash.tasks.queries.maintenance.cleanup_query_results job.id=e27209059575fcc17c527c47d0957cb21756e551 Running query results clean up (removing maximum of 500 unused results, that are 1 days old or more)
</code></pre>
</details>
<p>Following up on possible causes:</p>
<aside class="quote group-Team" data-post="12" data-topic="10115" data-username="jesse">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3428_2.png" width="20"/> jesse:</div>
<blockquote>
<p>It could be an insufficient number of workers monitoring the <code>periodic</code> queue.</p>
</blockquote>
</aside>
<p>The queue seems to be empty.<br/>
<div class="lightbox-wrapper"><a class="lightbox" data-download-href="/uploads/short-url/mtJV0X6eUHuzACstHlujuWfuyUd.png?dl=1" href="https://global.discourse-cdn.com/standard17/uploads/redash1/original/2X/9/9d8c7875426a85154319ff1f3a7bc44efecbd4e5.png" rel="noopener nofollow ugc" title="image"><img alt="image" data-base62-sha1="mtJV0X6eUHuzACstHlujuWfuyUd" data-small-upload="https://global.discourse-cdn.com/standard17/uploads/redash1/optimized/2X/9/9d8c7875426a85154319ff1f3a7bc44efecbd4e5_2_10x10.png" height="178" src="assets/9d8c7875426a85154319ff1f3a7bc44efecbd4e5_2_690x178.png" srcset="https://global.discourse-cdn.com/standard17/uploads/redash1/optimized/2X/9/9d8c7875426a85154319ff1f3a7bc44efecbd4e5_2_690x178.png, https://global.discourse-cdn.com/standard17/uploads/redash1/optimized/2X/9/9d8c7875426a85154319ff1f3a7bc44efecbd4e5_2_1035x267.png 1.5x, https://global.discourse-cdn.com/standard17/uploads/redash1/original/2X/9/9d8c7875426a85154319ff1f3a7bc44efecbd4e5.png 2x" width="690"/><div class="meta">
<svg aria-hidden="true" class="fa d-icon d-icon-far-image svg-icon"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">1066×275 12.3 KB</span><svg aria-hidden="true" class="fa d-icon d-icon-discourse-expand svg-icon"><use href="#discourse-expand"></use></svg>
</div></a></div></p>
<aside class="quote group-Team" data-post="12" data-topic="10115" data-username="jesse">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3428_2.png" width="20"/> jesse:</div>
<blockquote>
<ul>
<li>The worker is crashing before it can emit the log saying it’s picked up the task. To check for this, don’t grep for <code>cleanup_query_results</code>, but instead see if there are signs of a worker thread crashing.</li>
</ul>
</blockquote>
</aside>
<p>I looked but couldn’t find any signs. Are there any specific patterns to look for?</p>
<aside class="quote group-Team" data-post="12" data-topic="10115" data-username="jesse">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" loading="lazy" src="assets/3428_2.png" width="20"/> jesse:</div>
<blockquote>
<ul>
<li>The scheduler stops scheduling the job. To check for this, you can connect directly to the <code>redis</code> instance and pattern search for <code>cleanup_query_results</code> in the redis database.</li>
</ul>
</blockquote>
</aside>
<p>After Redash was restarted, I looked in Redis. I figured I should look for the job hash from the logs above and here’s what I’ve found:</p>
<pre><code class="lang-auto">rq:job:e27209059575fcc17c527c47d0957cb21756e551
 1) "enqueued_at"
 2) "2022-08-05T07:21:26.460464Z"
 5) "origin"
 6) "periodic"
 7) "status"
 8) "queued"
 9) "description"
10) "redash.tasks.queries.maintenance.cleanup_query_results()"
13) "timeout"
14) "180"
15) "created_at"
16) "2022-08-05T07:11:25.916441Z"
17) "result_ttl"
18) "600"
19) "ended_at"
20) "2022-08-05T07:15:41.703879Z"
21) "started_at"
22) "2022-08-05T07:15:37.820316Z"
</code></pre>
<p>I can see that job details do correlate with the logs above on schedule and execution. It also seems it was enqueued to run again but there were no signs of it in the logs. Not sure how tasks are registered in Redis but I was also not able to find the specific key again after 15 minutes or so (and of course the cleanup job hasn’t run ever since).</p>
<p>What would you suggest as next steps?</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_14" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/jesse.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/jesse_avatar.png" tabindex="-1" width="48"/><span itemprop="name">jesse</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-08-05T08:13:49Z" itemprop="datePublished">
                    August 5, 2022,  8:13am
                  </time>
<meta content="2022-08-05T08:13:49Z" itemprop="dateModified"/>
<span itemprop="position">14</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Excellent write up of your findings. I need a couple business days to dig into this more closely. I will follow up in this thread ASAP.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_15" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/phillipjohnson.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/phillipjohnson_avatar.png" tabindex="-1" width="48"/><span itemprop="name">phillipjohnson</span></a>
</span>
<link href="assets/10115" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2022-12-15T17:02:19Z" itemprop="datePublished">
                    December 15, 2022,  5:02pm
                  </time>
<meta content="2022-12-15T17:02:19Z" itemprop="dateModified"/>
<span itemprop="position">15</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hi, I am checking to see if there is any followup available? We seem to have a similar issue where the “periodic” queue is scheduled, we have 1 of four workers busy, with 3 idle. However, the query_results do not seem to be getting cleaned up.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="overlay" id="modalOverlay" style="display: none;">
<div class="modal-content">
<p>Login or sign up disabled while the site is in read only mode</p>
<hr/>
<button class="btn btn-login">OK</button>
</div>
</div>
<script src="../../js/script.js"></script>
</body>
</html>