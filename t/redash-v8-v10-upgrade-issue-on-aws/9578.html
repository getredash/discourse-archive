<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="../../css/checklist_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_theme_2_be4cb2b86ec06123c5e974acd20fd933d14b129d.css" rel="stylesheet"/>
<link href="../../css/discourse-adplugin_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-akismet_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-cakeday_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-chat-integration_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-details_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-footnote_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-lazy-videos_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-local-dates_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/color_definitions_base__2_8fd59ae1f286f43b3ff17996df07ea951685249d.css" rel="stylesheet"/>
<link href="../../css/style.css" rel="stylesheet"/>
<title>Redash v8-v10 upgrade issue on AWS</title></head>
<body>
<div class="navbar">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<div class="navbar-buttons">
<button class="btn btn-signup">Sign Up</button>
<button class="btn btn-login"><i class="fas fa-user"></i> Login</button>
<button class="btn btn-search"><i class="fas fa-search"></i></button>
<div class="navbar-toggle">
<div class="dots"></div>
<div class="dots"></div>
<div class="dots"></div>
</div>
</div>
</div>
<div class="sidebar">
<div class="sidebar-content">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<ul class="sidebar-grid">
<!-- <li><a href="#"><i class="fas fa-list-ul"></i> Topics</a></li> -->
<li><a href="../../page_0.html"><i class="fas fa-layer-group"></i> Topics</a></li>
<li><a href="../../users.html"><i class="fas fa-users"></i> Users</a></li>
<li><a href="../../about.html"><i class="fas fa-info-circle"></i> About</a></li>
<li><a href="../../faq.html"><i class="fas fa-question-circle"></i> FAQ</a></li>
<li><a href="../../groups.html"><i class="fas fa-users"></i> Groups</a></li>
<li><a href="../../badges.html"><i class="fas fa-certificate"></i> Badges</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#categories"><span>▼</span>Categories</a></h3>
<hr/>
<ul class="sidebar-grid categories">
<li>
<a class="badge-wrapper bullet" href="../../c/support/6.html">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name">Support</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/feature-requests/5.html">
<span class="badge-category-bg" style="background-color: #3AB54A"></span>
<span class="badge-category clear-badge">
<span class="category-name">Feature Requests</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/uncategorized/1.html">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name">Uncategorized</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/development/7.html">
<span class="badge-category-bg" style="background-color: #8C6238"></span>
<span class="badge-category clear-badge">
<span class="category-name">Development</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/tips-tricks-query-examples/11.html">
<span class="badge-category-bg" style="background-color: #652D90"></span>
<span class="badge-category clear-badge" style="white-space: normal;">
<span class="category-name">Tips, Tricks &amp; Query Examples</span>
</span>
</a>
</li>
<li><a href="../../categories.html"><i class="fas fa-list-ul"></i> All categories</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#tags"><span>▼</span>Tags</a></h3>
<hr/>
<ul class="sidebar-grid tags">
<li><a href="../../tag/query_results.html"><i class="fas fa-tag"></i> query_results</a></li>
<li><a href="../../tag/feature-request.html"><i class="fas fa-tag"></i> feature-request</a></li>
<li><a href="../../tag/parameters.html"><i class="fas fa-tag"></i> parameters</a></li>
<li><a href="../../tag/visualizations.html"><i class="fas fa-tag"></i> visualizations</a></li>
<li><a href="../../tag/alerts.html"><i class="fas fa-tag"></i> alerts</a></li>
<li><a href="../../tags.html"><i class="fas fa-list-ul"></i> All tags</a></li>
</ul>
</div>
<div class="sidebar-footer">
            © 2023 <a href="https://discuss.redash.io/" target="_blank">discuss.redash.io</a>
</div>
</div>
<div class="overlay"></div>
<div class="content">
<div class="global-notice">
<div class="row">
<div class="alert alert-info alert-read-only" id="global-notice-alert-read-only">
<span class="text">This site is in read only mode. Please continue to browse, but replying, likes,
                        and other actions are disabled for now.</span>
</div>
</div>
</div>
<div class="imported_page" id="imported_page">
<div class="wrap" id="main-outlet" role="main">
<div id="topic-title">
<h1>
<a href="/t/redash-v8-v10-upgrade-issue-on-aws/9578">Redash v8-v10 upgrade issue on AWS</a>
</h1>
<div class="topic-category" itemscope="" itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/support/6.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Support</span>
</span>
</a>
<meta content="1" itemprop="position"/>
</span>
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/support/support-self-hosted/9.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Self Hosted Redash Support</span>
</span>
</a>
<meta content="2" itemprop="position"/>
</span>
</div>
</div>
<div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
<meta content="Redash v8-v10 upgrade issue on AWS" itemprop="headline"/>
<meta content="Self Hosted Redash Support" itemprop="articleSection"/>
<meta content="" itemprop="keywords"/>
<div itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
<meta content="Redash Discourse" itemprop="name"/>
<div itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject">
<meta content="https://global.discourse-cdn.com/standard17/uploads/redash1/original/1X/c07bc573841e1e4a0013ea3b6fe088a1534228a3.png" itemprop="url"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_1">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/krishnaku.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/krishnaku_avatar.png" tabindex="-1" width="48"/><span itemprop="name">krishnaku</span></a>
</span>
<link href="assets/9578" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2021-11-30T01:17:21Z" itemprop="datePublished">
                    November 30, 2021,  1:17am
                  </time>
<meta content="2021-11-30T04:39:05Z" itemprop="dateModified"/>
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<h3>
<a class="anchor" href="#issue-summary-1" name="issue-summary-1"></a>Issue Summary</h3>
<p>I am running into an issue upgrading a self-hosted redash server on AWS EC2 from v8 to v10.</p>
<p>I’ve followed the instructions in the upgrade guide, and the individual steps completed without errors,<br/>
but once I do a docker-compose up -d at the end, the server service keeps crashing and rebooting the workers constantly. There dont seem to be any useful errors to trouble shoot what is going on.</p>
<p>The database migration ran and the alembic_version in the database is currently: 89bc7873a3e0<br/>
which I believe is v10 Head.</p>
<p>These are the docker-compose logs for the server.</p>
<pre><code class="lang-auto">Attaching to redash_server_1
server_1            | [2021-11-30 00:50:29 +0000] [1] [INFO] Starting gunicorn 20.0.4
server_1            | [2021-11-30 00:50:29 +0000] [1] [INFO] Listening at: http://0.0.0.0:5000 (1)
server_1            | [2021-11-30 00:50:29 +0000] [1] [INFO] Using worker: sync
server_1            | [2021-11-30 00:50:29 +0000] [9] [INFO] Booting worker with pid: 9
server_1            | [2021-11-30 00:50:29 +0000] [8] [INFO] Booting worker with pid: 8
server_1            | [2021-11-30 00:50:29 +0000] [10] [INFO] Booting worker with pid: 10

server_1            | [2021-11-30 00:50:29 +0000] [11] [INFO] Booting worker with pid: 11
server_1            | [2021-11-30 00:50:59 +0000] [1] [CRITICAL] WORKER TIMEOUT (pid:8)
server_1            | [2021-11-30 00:50:59 +0000] [1] [CRITICAL] WORKER TIMEOUT (pid:9)
server_1            | [2021-11-30 00:50:59 +0000] [1] [CRITICAL] WORKER TIMEOUT (pid:10)
server_1            | [2021-11-30 00:50:59 +0000] [1] [CRITICAL] WORKER TIMEOUT (pid:11)
server_1            | [2021-11-30 00:51:00 +0000] [16] [INFO] Booting worker with pid: 16
server_1            | [2021-11-30 00:51:00 +0000] [17] [INFO] Booting worker with pid: 17
server_1            | [2021-11-30 00:51:00 +0000] [18] [INFO] Booting worker with pid: 18
server_1            | [2021-11-30 00:51:00 +0000] [19] [INFO] Booting worker with pid: 19
</code></pre>
<p>This sequence just keeps repeating and the EC2 instance becomes unresponsive and needs to be restarted.</p>
<p>A summary of the issue and the browser/OS environment in which it occurs.</p>
<h3>
<a class="anchor" href="#technical-details-2" name="technical-details-2"></a>Technical details:</h3>
<ul>
<li>Redash Version: v10.1.0</li>
<li>Browser/OS: chrome/macos</li>
<li>How did you install Redash: AWS Ec2 image for v8 upgraded via the upgrade process.</li>
</ul>
<p>Docker-compose (updated for v10)</p>
<pre><code class="lang-auto">version: "2"
x-redash-service: &amp;redash-service
  image: redash/redash:10.0.0.b50363
  depends_on:
    - postgres
    - redis
  env_file: /opt/redash/env
  restart: always
services:
  server:
    &lt;&lt;: *redash-service
    command: server
    ports:
      - "5000:5000"
    environment:
      REDASH_WEB_WORKERS: 4
  scheduler:
    &lt;&lt;: *redash-service
    command: scheduler
 
  worker:
    &lt;&lt;: *redash-service
    command: worker
    environment:
      QUEUES: "periodic emails default"
      WORKERS_COUNT: 1

  scheduled_worker:
    &lt;&lt;: *redash-service
    command: worker
    environment:
      QUEUES: "scheduled_queries,schemas"
      WORKERS_COUNT: 1
  adhoc_worker:
    &lt;&lt;: *redash-service
    command: worker
    environment:
      QUEUES: "queries"
      WORKERS_COUNT: 2
  redis:
    image: redis:5.0-alpine
    restart: always
  postgres:
    image: postgres:9.6-alpine
    env_file: /opt/redash/env
    volumes:
      - /opt/redash/postgres-data:/var/lib/postgresql/data
    restart: always
    ports:
      - "5432:5432"

  nginx:
    image: redash/nginx:latest
    ports:
      - "80:80"
      - "443:443"

    depends_on:
      - server
    links:
      - server:redash
    volumes:
      - /opt/redash/nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      - /opt/redash/nginx/certs:/etc/letsencrypt
      - /opt/redash/nginx/certs-data:/data/letsencrypt
    restart: always
</code></pre>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_2" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/jesse.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/jesse_avatar.png" tabindex="-1" width="48"/><span itemprop="name">jesse</span></a>
</span>
<link href="assets/9578" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2021-11-30T04:43:03Z" itemprop="datePublished">
                    November 30, 2021,  4:43am
                  </time>
<meta content="2021-11-30T04:43:03Z" itemprop="dateModified"/>
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Thanks for your question. In case you want to see what this process looks like in real time there’s a demo on Youtube here: <a class="inline-onebox" href="https://www.youtube.com/watch?v=PoOAra588dA">Upgrade from V8 to V10 Walkthrough - YouTube</a></p>
<p>To your specific situation: what exact steps did you follow to upgrade your instance? There are special instructions for upgrading to V10 from V8 (see <a href="https://github.com/getredash/redash/releases/v10.1.0">here</a>). It seems like you may not have rebuilt your containers (step 7)</p>
<p>Second, any reason why you’re upgrading to 10.0 instead of 10.1 which includes the security patches we pushed last week?</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_3" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/krishnaku.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/krishnaku_avatar.png" tabindex="-1" width="48"/><span itemprop="name">krishnaku</span></a>
</span>
<link href="assets/9578" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2021-11-30T15:45:51Z" itemprop="datePublished">
                    November 30, 2021,  3:45pm
                  </time>
<meta content="2021-11-30T15:45:51Z" itemprop="dateModified"/>
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hi Jesse,</p>
<p>Thanks for the quick response!<br/>
I went back through the video and followed the steps to migrate from my v8 instance to v10 again, but still facing the same issue.</p>
<p>Things I missed the last time around:</p>
<ol>
<li>I had removed the environment settings in docker-compose only for the scheduler service, but your video shows that you remove it from all the other worker service entries (not sure if it is material since this seems related to replacing celery with RQ, but I did not think it would hurt).</li>
<li>Hit ctrl C to stop the docker-compose up --recreate-containers --build command. I had run this before, but I did not stop it.</li>
<li>I reran the migrations again to ensure that nothing was missed (the database had already been migrated in a previous run).</li>
</ol>
<p>But I am still seeing the following in the docker logs for the server.</p>
<p>[2021-11-30 15:34:21 +0000] [1] [INFO] Starting gunicorn 20.0.4<br/>
[2021-11-30 15:34:21 +0000] [1] [INFO] Listening at: <a href="http://0.0.0.0:5000" rel="noopener nofollow ugc">http://0.0.0.0:5000</a> (1)<br/>
[2021-11-30 15:34:21 +0000] [1] [INFO] Using worker: sync<br/>
[2021-11-30 15:34:21 +0000] [8] [INFO] Booting worker with pid: 8<br/>
[2021-11-30 15:34:21 +0000] [9] [INFO] Booting worker with pid: 9<br/>
[2021-11-30 15:34:21 +0000] [10] [INFO] Booting worker with pid: 10<br/>
[2021-11-30 15:34:21 +0000] [11] [INFO] Booting worker with pid: 11<br/>
[2021-11-30 15:34:51 +0000] [1] [CRITICAL] WORKER TIMEOUT (pid:8)<br/>
[2021-11-30 15:34:51 +0000] [1] [CRITICAL] WORKER TIMEOUT (pid:9)<br/>
[2021-11-30 15:34:51 +0000] [1] [CRITICAL] WORKER TIMEOUT (pid:10)<br/>
[2021-11-30 15:34:51 +0000] [1] [CRITICAL] WORKER TIMEOUT (pid:11)<br/>
[2021-11-30 15:34:51 +0000] [8] [INFO] Worker exiting (pid: 8)<br/>
[2021-11-30 15:34:51 +0000] [9] [INFO] Worker exiting (pid: 9)<br/>
[2021-11-30 15:34:51 +0000] [10] [INFO] Worker exiting (pid: 10)<br/>
[2021-11-30 15:34:51 +0000] [11] [INFO] Worker exiting (pid: 11)<br/>
[2021-11-30 15:34:53 +0000] [17] [INFO] Booting worker with pid: 17<br/>
[2021-11-30 15:34:53 +0000] [16] [INFO] Booting worker with pid: 16<br/>
[2021-11-30 15:34:53 +0000] [18] [INFO] Booting worker with pid: 18<br/>
[2021-11-30 15:34:53 +0000] [19] [INFO] Booting worker with pid: 19</p>
<p>For some reason, the server worker process started by gunicorn is crashing. Are there ways to turn on debug logs to see what the issue might be.</p>
<p>I was also running the v8 instance in a t3.small EC2 instance. I upgraded to a t3a.medium instance thinking it may be a memory issue, but it does not seem to have had any impact.</p>
<p>Any further thoughts/suggestions on what I might do here?</p>
<p>Krishna</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_4" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/krishnaku.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/krishnaku_avatar.png" tabindex="-1" width="48"/><span itemprop="name">krishnaku</span></a>
</span>
<link href="assets/9578" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2021-11-30T16:03:41Z" itemprop="datePublished">
                    November 30, 2021,  4:03pm
                  </time>
<meta content="2021-11-30T16:03:41Z" itemprop="dateModified"/>
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Actually it was something silly on my end. I had the wrong image tag on the docker-compose - was doing the 10.0 instead of the 10.1 image. Changing that fixed the issue and the v10 instance is up now.</p>
<p>Thanks again for the detailed instructions!</p>
<p>Krishna</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="overlay" id="modalOverlay" style="display: none;">
<div class="modal-content">
<p>Login or sign up disabled while the site is in read only mode</p>
<hr/>
<button class="btn btn-login">OK</button>
</div>
</div>
<script src="../../js/script.js"></script>
</body>
</html>