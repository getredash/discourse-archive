<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="../../css/checklist_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_theme_2_be4cb2b86ec06123c5e974acd20fd933d14b129d.css" rel="stylesheet"/>
<link href="../../css/discourse-adplugin_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-akismet_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-cakeday_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-chat-integration_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-details_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-footnote_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-lazy-videos_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-local-dates_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/color_definitions_base__2_8fd59ae1f286f43b3ff17996df07ea951685249d.css" rel="stylesheet"/>
<link href="../../css/style.css" rel="stylesheet"/>
<title>Worker shutdowns in v9 resulting in stuck queries</title></head>
<body>
<div class="navbar">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<div class="navbar-buttons">
<button class="btn btn-signup">Sign Up</button>
<button class="btn btn-login"><i class="fas fa-user"></i> Login</button>
<button class="btn btn-search"><i class="fas fa-search"></i></button>
<div class="navbar-toggle">
<div class="dots"></div>
<div class="dots"></div>
<div class="dots"></div>
</div>
</div>
</div>
<div class="sidebar">
<div class="sidebar-content">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<ul class="sidebar-grid">
<!-- <li><a href="#"><i class="fas fa-list-ul"></i> Topics</a></li> -->
<li><a href="../../page_0.html"><i class="fas fa-layer-group"></i> Topics</a></li>
<li><a href="../../users.html"><i class="fas fa-users"></i> Users</a></li>
<li><a href="../../about.html"><i class="fas fa-info-circle"></i> About</a></li>
<li><a href="../../faq.html"><i class="fas fa-question-circle"></i> FAQ</a></li>
<li><a href="../../groups.html"><i class="fas fa-users"></i> Groups</a></li>
<li><a href="../../badges.html"><i class="fas fa-certificate"></i> Badges</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#categories"><span>▼</span>Categories</a></h3>
<hr/>
<ul class="sidebar-grid categories">
<li>
<a class="badge-wrapper bullet" href="../../c/support/6.html">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name">Support</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/feature-requests/5.html">
<span class="badge-category-bg" style="background-color: #3AB54A"></span>
<span class="badge-category clear-badge">
<span class="category-name">Feature Requests</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/uncategorized/1.html">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name">Uncategorized</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/development/7.html">
<span class="badge-category-bg" style="background-color: #8C6238"></span>
<span class="badge-category clear-badge">
<span class="category-name">Development</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/tips-tricks-query-examples/11.html">
<span class="badge-category-bg" style="background-color: #652D90"></span>
<span class="badge-category clear-badge" style="white-space: normal;">
<span class="category-name">Tips, Tricks &amp; Query Examples</span>
</span>
</a>
</li>
<li><a href="../../categories.html"><i class="fas fa-list-ul"></i> All categories</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#tags"><span>▼</span>Tags</a></h3>
<hr/>
<ul class="sidebar-grid tags">
<li><a href="../../tag/query_results.html"><i class="fas fa-tag"></i> query_results</a></li>
<li><a href="../../tag/feature-request.html"><i class="fas fa-tag"></i> feature-request</a></li>
<li><a href="../../tag/parameters.html"><i class="fas fa-tag"></i> parameters</a></li>
<li><a href="../../tag/visualizations.html"><i class="fas fa-tag"></i> visualizations</a></li>
<li><a href="../../tag/alerts.html"><i class="fas fa-tag"></i> alerts</a></li>
<li><a href="../../tags.html"><i class="fas fa-list-ul"></i> All tags</a></li>
</ul>
</div>
<div class="sidebar-footer">
            © 2023 <a href="https://discuss.redash.io/" target="_blank">discuss.redash.io</a>
</div>
</div>
<div class="overlay"></div>
<div class="content">
<div class="global-notice">
<div class="row">
<div class="alert alert-info alert-read-only" id="global-notice-alert-read-only">
<span class="text">This site is in read only mode. Please continue to browse, but replying, likes,
                        and other actions are disabled for now.</span>
</div>
</div>
</div>
<div class="imported_page" id="imported_page">
<div class="wrap" id="main-outlet" role="main">
<div id="topic-title">
<h1>
<a href="/t/worker-shutdowns-in-v9-resulting-in-stuck-queries/7382">Worker shutdowns in v9 resulting in stuck queries</a>
</h1>
<div class="topic-category" itemscope="" itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/support/6.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Support</span>
</span>
</a>
<meta content="1" itemprop="position"/>
</span>
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/support/support-self-hosted/9.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Self Hosted Redash Support</span>
</span>
</a>
<meta content="2" itemprop="position"/>
</span>
</div>
</div>
<div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
<meta content="Worker shutdowns in v9 resulting in stuck queries" itemprop="headline"/>
<meta content="Self Hosted Redash Support" itemprop="articleSection"/>
<meta content="" itemprop="keywords"/>
<div itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
<meta content="Redash Discourse" itemprop="name"/>
<div itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject">
<meta content="https://global.discourse-cdn.com/standard17/uploads/redash1/original/1X/c07bc573841e1e4a0013ea3b6fe088a1534228a3.png" itemprop="url"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_1">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/joshbohde.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/joshbohde_avatar.png" tabindex="-1" width="48"/><span itemprop="name">joshbohde</span></a>
</span>
<link href="https://discuss.redash.io/t/worker-shutdowns-in-v9-resulting-in-stuck-queries/7382" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-10-15T15:14:55Z" itemprop="datePublished">
                    October 15, 2020,  3:14pm
                  </time>
<meta content="2020-10-15T15:14:55Z" itemprop="dateModified"/>
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<h3>Issue Summary</h3>
<p>Whenever a worker container shuts down, there is a possibility that in-flight queries on that worker will remain stuck in the “started” state in RQ. This prevents any user from being able to refresh that query, since all attempts will use the existing query.</p>
<h3>Technical details:</h3>
<ul>
<li>Redash Version: 9.0.0-beta.b42121</li>
<li>Browser/OS: Debian</li>
<li>How did you install Redash: Self-hosted Kubernetes</li>
</ul>
<h3>Environment</h3>
<p>We run our workers on an autoscaling group inside AWS, and I noticed this behavior on instance termination. We send <code>SIGTERM</code> to the process, and wait for it to shutdown before teminating the node. The worker container runs the following command: <code>docker-entrypoint worker</code></p>
<p>A query that can take a few minutes to complete started on a worker that was shutdown during query execution:</p>
<pre><code class="lang-auto">[2020-10-15 12:25:00,758][PID:15][INFO][rq.worker] queries: 4a033c0a-d4e6-493a-865d-fd24726e432e
[2020-10-15 12:25:00,782][PID:147][INFO][rq.job.redash.tasks.queries.execution] job.func_name=redash.tasks.queries.execution.execute_query job.id=4a033c0a-d4e6-493a-865d-fd24726e432e job=execute_query state=load_ds ds_id=2
[2020-10-15 12:25:01,019][PID:147][INFO][rq.job.redash.tasks.queries.execution] job.func_name=redash.tasks.queries.execution.execute_query job.id=4a033c0a-d4e6-493a-865d-fd24726e432e job=execute_query state=executing_query query_hash=255f676cfc06ebe953c96a286e8aa08f type=rds_mysql ds_id=2  job_id=4a033c0a-d4e6-493a-865d-fd24726e432e queue=queries query_id=12 username=&lt;redacted&gt;
Oct 15 07:30:31 shutting down, got signal: Terminated
</code></pre>
<p>I don’t have any more logs from the container itself after receiving <code>SIGTERM</code>, but I can see that the whole process tree has exited within the same second as the shutdown message. Under <code>/api/admin/queries/rq_status</code>, I can see that the worker that was is eventually removed, but the query itself remains in the list of started queries. In redis, the status is still listed as “started”:</p>
<pre><code class="lang-auto">$ redis-cli hget rq:job:4a033c0a-d4e6-493a-865d-fd24726e432e "status"
"started"
</code></pre>
<p>I expected there to be a 10 second delay between <code>SIGTERM</code> and process exit based upon the supervisord default <code>stopwaitseconds</code> (<a href="http://supervisord.org/configuration.html#program-x-section-settings" rel="noopener nofollow ugc">http://supervisord.org/configuration.html#program-x-section-settings</a>), and the RQ signal handling (<a href="https://python-rq.org/docs/workers/#taking-down-workers" rel="noopener nofollow ugc">https://python-rq.org/docs/workers/#taking-down-workers</a>). There’s no indication that the underlying RQ process is handling this signal from the logs.</p>
<p>It is possible to manually recover this by running <code>redis-cli del rq:job:4a033c0a-d4e6-493a-865d-fd24726e432e</code> and refreshing the query inside Redash.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
<div class="crawler-linkback-list" itemscope="" itemtype="http://schema.org/ItemList">
<div itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a href="http://discuss.redash.io/t/scheduled-queries-are-not-being-executed-and-were-found-in-outdated-queries/7985/9" itemprop="url">Scheduled queries are not being executed and were found in outdated queries</a>
<meta content="3" itemprop="position"/>
</div>
<div itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a href="http://discuss.redash.io/t/scheduled-queries-are-not-being-executed-and-were-found-in-outdated-queries/7985/8" itemprop="url">Scheduled queries are not being executed and were found in outdated queries</a>
<meta content="4" itemprop="position"/>
</div>
</div>
</div>
<div class="topic-body crawler-post" id="post_2" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/joshbohde.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/joshbohde_avatar.png" tabindex="-1" width="48"/><span itemprop="name">joshbohde</span></a>
</span>
<link href="https://discuss.redash.io/t/worker-shutdowns-in-v9-resulting-in-stuck-queries/7382" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-10-15T19:26:42Z" itemprop="datePublished">
                    October 15, 2020,  7:26pm
                  </time>
<meta content="2020-10-15T19:26:42Z" itemprop="dateModified"/>
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I’ve submitted a pull request that should address part of this here: <a href="https://github.com/getredash/redash/pull/5214" rel="noopener nofollow ugc">https://github.com/getredash/redash/pull/5214</a></p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_3" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/arikfr.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/arikfr_avatar.png" tabindex="-1" width="48"/><span itemprop="name">arikfr</span></a>
</span>
<link href="https://discuss.redash.io/t/worker-shutdowns-in-v9-resulting-in-stuck-queries/7382" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-10-18T18:28:04Z" itemprop="datePublished">
                    October 18, 2020,  6:28pm
                  </time>
<meta content="2020-10-18T18:28:04Z" itemprop="dateModified"/>
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Thank you for the detailed report and the pull request. But I wonder if it’s worth addressing this from the root, and adding logic to detect queries that are in <code>started</code> state, but their worker is no longer around. Because even if we try to perform a clean shutdown, it’s always possible that something will go wrong.</p>
<p>Did you have a chance to look into this?</p>
<p>Btw, we’re <a href="https://github.com/getredash/redash/pull/5207/files">upgrading to RQ 1.5</a>, so maybe something changed in regards to this in the new version?</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_4" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/joshbohde.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/joshbohde_avatar.png" tabindex="-1" width="48"/><span itemprop="name">joshbohde</span></a>
</span>
<link href="https://discuss.redash.io/t/worker-shutdowns-in-v9-resulting-in-stuck-queries/7382" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-10-19T17:50:59Z" itemprop="datePublished">
                    October 19, 2020,  5:50pm
                  </time>
<meta content="2020-10-19T17:50:59Z" itemprop="dateModified"/>
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I think the process you describe is a helpful long term solution, but in my investigation of the source, I didn’t find a quick path to implementing this. This model does allow two workers to run the same query at the same time in the event of a network partition. This could be fixed by a lease system where a worker stops running a query if it loses the lease.</p>
<p>I’ve looked into the RQ 1.5 docs, and it does provide <a href="https://python-rq.org/docs/exceptions/" rel="noopener nofollow ugc">retries</a>, which could be a useful addition during a graceful shutdown. I’ve not found anything that would help in a hard shutdown or network partition.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_5" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/Albert.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/Albert_avatar.png" tabindex="-1" width="48"/><span itemprop="name">Albert</span></a>
</span>
<link href="https://discuss.redash.io/t/worker-shutdowns-in-v9-resulting-in-stuck-queries/7382" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2021-02-12T20:14:01Z" itemprop="datePublished">
                    February 12, 2021,  8:14pm
                  </time>
<meta content="2021-02-12T20:14:01Z" itemprop="dateModified"/>
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p>We are deploying the V9-beta on ECS fargate, I’m having the exactly the same situation: <a class="inline-onebox" href="http://discuss.redash.io/t/scheduled-queries-are-not-being-executed-and-were-found-in-outdated-queries/7985">Scheduled queries are not being executed and were found in outdated queries</a></p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="overlay" id="modalOverlay" style="display: none;">
<div class="modal-content">
<p>Login or sign up disabled while the site is in read only mode</p>
<hr/>
<button class="btn btn-login">OK</button>
</div>
</div>
<script src="../../js/script.js"></script>
</body>
</html>