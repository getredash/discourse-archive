<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="../../css/checklist_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_theme_2_be4cb2b86ec06123c5e974acd20fd933d14b129d.css" rel="stylesheet"/>
<link href="../../css/discourse-adplugin_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-akismet_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-cakeday_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-chat-integration_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-details_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-footnote_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-lazy-videos_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-local-dates_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/color_definitions_base__2_8fd59ae1f286f43b3ff17996df07ea951685249d.css" rel="stylesheet"/>
<link href="../../css/style.css" rel="stylesheet"/>
<title>EC2 Deployment Instance Size Issue</title></head>
<body>
<div class="navbar">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<div class="navbar-buttons">
<button class="btn btn-signup">Sign Up</button>
<button class="btn btn-login"><i class="fas fa-user"></i> Login</button>
<button class="btn btn-search"><i class="fas fa-search"></i></button>
<div class="navbar-toggle">
<div class="dots"></div>
<div class="dots"></div>
<div class="dots"></div>
</div>
</div>
</div>
<div class="sidebar">
<div class="sidebar-content">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<ul class="sidebar-grid">
<!-- <li><a href="#"><i class="fas fa-list-ul"></i> Topics</a></li> -->
<li><a href="../../page_0.html"><i class="fas fa-layer-group"></i> Topics</a></li>
<li><a href="../../users.html"><i class="fas fa-users"></i> Users</a></li>
<li><a href="../../about.html"><i class="fas fa-info-circle"></i> About</a></li>
<li><a href="../../faq.html"><i class="fas fa-question-circle"></i> FAQ</a></li>
<li><a href="../../groups.html"><i class="fas fa-users"></i> Groups</a></li>
<li><a href="../../badges.html"><i class="fas fa-certificate"></i> Badges</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#categories"><span>▼</span>Categories</a></h3>
<hr/>
<ul class="sidebar-grid categories">
<li>
<a class="badge-wrapper bullet" href="../../c/support/6.html">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name">Support</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/feature-requests/5.html">
<span class="badge-category-bg" style="background-color: #3AB54A"></span>
<span class="badge-category clear-badge">
<span class="category-name">Feature Requests</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/uncategorized/1.html">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name">Uncategorized</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/development/7.html">
<span class="badge-category-bg" style="background-color: #8C6238"></span>
<span class="badge-category clear-badge">
<span class="category-name">Development</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/tips-tricks-query-examples/11.html">
<span class="badge-category-bg" style="background-color: #652D90"></span>
<span class="badge-category clear-badge" style="white-space: normal;">
<span class="category-name">Tips, Tricks &amp; Query Examples</span>
</span>
</a>
</li>
<li><a href="../../categories.html"><i class="fas fa-list-ul"></i> All categories</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#tags"><span>▼</span>Tags</a></h3>
<hr/>
<ul class="sidebar-grid tags">
<li><a href="../../tag/query_results.html"><i class="fas fa-tag"></i> query_results</a></li>
<li><a href="../../tag/feature-request.html"><i class="fas fa-tag"></i> feature-request</a></li>
<li><a href="../../tag/parameters.html"><i class="fas fa-tag"></i> parameters</a></li>
<li><a href="../../tag/visualizations.html"><i class="fas fa-tag"></i> visualizations</a></li>
<li><a href="../../tag/alerts.html"><i class="fas fa-tag"></i> alerts</a></li>
<li><a href="../../tags.html"><i class="fas fa-list-ul"></i> All tags</a></li>
</ul>
</div>
<div class="sidebar-footer">
            © 2023 <a href="https://discuss.redash.io/" target="_blank">discuss.redash.io</a>
</div>
</div>
<div class="overlay"></div>
<div class="content">
<div class="global-notice">
<div class="row">
<div class="alert alert-info alert-read-only" id="global-notice-alert-read-only">
<span class="text">This site is in read only mode. Please continue to browse, but replying, likes,
                        and other actions are disabled for now.</span>
</div>
</div>
</div>
<div class="imported_page" id="imported_page">
<div class="wrap" id="main-outlet" role="main">
<div id="topic-title">
<h1>
<a href="/t/ec2-deployment-instance-size-issue/9271">EC2 Deployment Instance Size Issue</a>
</h1>
<div class="topic-category" itemscope="" itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/support/6.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Support</span>
</span>
</a>
<meta content="1" itemprop="position"/>
</span>
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/support/support-self-hosted/9.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Self Hosted Redash Support</span>
</span>
</a>
<meta content="2" itemprop="position"/>
</span>
</div>
</div>
<div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
<meta content="EC2 Deployment Instance Size Issue" itemprop="headline"/>
<meta content="Self Hosted Redash Support" itemprop="articleSection"/>
<meta content="" itemprop="keywords"/>
<div itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
<meta content="Redash Discourse" itemprop="name"/>
<div itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject">
<meta content="https://global.discourse-cdn.com/standard17/uploads/redash1/original/1X/c07bc573841e1e4a0013ea3b6fe088a1534228a3.png" itemprop="url"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_1">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/jesse.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/jesse_avatar.png" tabindex="-1" width="48"/><span itemprop="name">jesse</span></a>
</span>
<link href="assets/9271" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2021-10-15T16:12:56Z" itemprop="datePublished">
                    October 15, 2021,  4:12pm
                  </time>
<meta content="2021-10-15T16:12:56Z" itemprop="dateModified"/>
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p><strong>tl;dr</strong> minimum EC2 instance size for V10 is t2.medium. Any ideas why?</p>
<h1>
<a class="anchor" href="#background-1" name="background-1"></a>Background</h1>
<p>One of our <a href="http://discuss.redash.io/t/v10-follow-up-items/9257">V10 release follow-ups</a> is to build new cloud images for V10. We build these images by running our <a>setup script</a> through <a href="https://www.packer.io/">Packer</a>. Until this work is finished, you can use V10 in EC2 still, just deploy a V8 image and upgrade it.</p>
<p>Per our <a href="https://redash.io/help/open-source/setup#aws">documentation</a>:</p>
<blockquote>
<p>Launch the instance with the pre-baked AMI we create (for small deployments t2.small should be enough):</p>
</blockquote>
<h1>
<a class="anchor" href="#the-problem-2" name="the-problem-2"></a>The Problem</h1>
<p>A t2.small instance doesn’t have enough RAM for V10. We didn’t expect this. And it’s quite annoying. Because the V8 image will deploy on t2.small and will run normally. But once you upgrade to V10 and restart the containers, the instance becomes non-responsive.</p>
<p>You need to change the instance type to t2.medium before service is restored.</p>
<h2>
<a class="anchor" href="#v8-resource-consumption-3" name="v8-resource-consumption-3"></a>V8 Resource Consumption</h2>
<p>Here’s the output from <code>sudo docker stats</code> on a V8 instance that wasn’t upgraded. Notice total available RAM is just under 2gb. About 75% of this is in use.</p>
<pre><code class="lang-auto">CONTAINER ID        NAME                        CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS
074069f3c875        redash_nginx_1              0.00%               2.492MiB / 1.945GiB   0.13%               8.01MB / 3.52MB     34.8MB / 0B         2
ba89d824f682        redash_adhoc_worker_1       0.05%               291.7MiB / 1.945GiB   14.65%              126MB / 59.3MB      101MB / 0B          3
6aba3ac4a872        redash_scheduler_1          0.17%               274.8MiB / 1.945GiB   13.80%              138MB / 81.8MB      645MB / 12.1MB      3
39d98fe4cf2a        redash_server_1             0.01%               670.3MiB / 1.945GiB   33.65%              1.16MB / 8.62MB     302MB / 0B          5
b2a9ccd1285b        redash_scheduled_worker_1   0.13%               190.2MiB / 1.945GiB   9.55%               126MB / 68MB        90.3MB / 0B         2
1e40cfb160a2        redash_postgres_1           0.01%               13.39MiB / 1.945GiB   0.67%               6.09MB / 5.45MB     382MB / 134MB       12
bc73e56ac9a2        redash_redis_1              0.18%               2.477MiB / 1.945GiB   0.12%               204MB / 385MB       84.6MB / 71.4MB     4
</code></pre>
<h2>
<a class="anchor" href="#v10-resource-consumption-4" name="v10-resource-consumption-4"></a>V10 Resource Consumption</h2>
<p>Here’s the output from <code>sudo docker stats</code> on a V8 instance upgraded to V10. Total available RAM is just under 4gb (because this is a t2.medium instance) and total RAM consumption is around 2100Mb.</p>
<pre><code class="lang-auto">CONTAINER ID        NAME                    CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS
d013031b8481        redash_nginx_1          0.00%               3.188MiB / 3.842GiB   0.08%               8.7MB / 4.42MB      0B / 0B             2
e44e049a70cf        redash_scheduler_1      0.00%               195.1MiB / 3.842GiB   4.96%               10.5MB / 18.7MB     0B / 0B             2
e0e0d1829567        redash_adhoc_worker_1   0.03%               589MiB / 3.842GiB     14.97%              4.49MB / 6.42MB     627kB / 0B          7
61bcba583f8e        redash_worker_1         0.03%               590.3MiB / 3.842GiB   15.01%              35.3MB / 54.4MB     77.8kB / 0B         7
7eb1a4502a89        redash_server_1         0.01%               772.1MiB / 3.842GiB   19.63%              1.61MB / 9.19MB     1.15MB / 0B         9
ff160d1d6d48        redash_postgres_1       0.00%               11.86MiB / 3.842GiB   0.30%               11.1MB / 11.5MB     762kB / 42.8MB      10
149b61ecedcd        redash_redis_1          0.15%               2.473MiB / 3.842GiB   0.06%               69.6MB / 39.9MB     0B / 2.54MB         4
</code></pre>
<h2>
<a class="anchor" href="#analysis-5" name="analysis-5"></a>Analysis</h2>
<p>The V10 instance containers are using than the maximum RAM available on the t2.small instance (2gb). This means the system starts swapping, which is slow. This is the cause of degraded performance on the upgraded system.</p>
<p>What isn’t clear is <em>why</em> the containers use more memory in V10 than V8. The only containers that are comparable are the <code>redis</code>, <code>postgres</code>, and <code>nginx</code> containers (which come from images we don’t maintain).</p>
<p>From what I can tell, there’s no reason V10 should require this much RAM for a basic deployment. But I’d like to figure this out before we build the new images. In case there is an easy tweak we can make to the setup script that avoids it.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_2" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/justinclift.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/justinclift_avatar.png" tabindex="-1" width="48"/><span itemprop="name">justinclift</span></a>
</span>
<link href="assets/9271" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2021-10-16T14:42:45Z" itemprop="datePublished">
                    October 16, 2021,  2:42pm
                  </time>
<meta content="2021-10-16T15:02:04Z" itemprop="dateModified"/>
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>As an initial sanity check, to help narrow down potential causes… will the V10 application run if you build its image with the same NodeJS version as <a href="https://github.com/getredash/redash/blob/a16f551e22c6288df6f067aa12caa5afd9a8f1dd/Dockerfile#L1" rel="noopener nofollow ugc">the V8 images</a> (eg node:10)?</p>
<p>Note - I’m not suggesting to do this for the production build.  More suggesting it as something to investigate. <img alt=":slight_smile:" class="emoji" src="assets/slight_smile.png" title=":slight_smile:"/></p>
<p>If it does build and run ok, I’d try that and see if it’s the newer NodeJS version causing the problem.</p>
<p>Ditto, similar type of thought for the Python processes.  Maybe see if you can run the new V10 Python code using the older V8 python base (or the old v8 code on the new V10 python base), then compare.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_3" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/justinclift.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/justinclift_avatar.png" tabindex="-1" width="48"/><span itemprop="name">justinclift</span></a>
</span>
<link href="assets/9271" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2021-10-17T04:43:12Z" itemprop="datePublished">
                    October 17, 2021,  4:43am
                  </time>
<meta content="2021-10-17T04:43:12Z" itemprop="dateModified"/>
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Heh, I should probably ensure I’m not super tired when posting replies to things. <img alt=":wink:" class="emoji" src="assets/wink.png" title=":wink:"/></p>
<p>That being said, the concept from my post above - try running both code bases using the same foundation - is a reasonable approach for trying to figure out runtime operational differences.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
<div class="crawler-linkback-list" itemscope="" itemtype="http://schema.org/ItemList">
<div itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a href="http://discuss.redash.io/t/memory-maxing-out-then-504/9308/2" itemprop="url">Memory maxing out then 504</a>
<meta content="1" itemprop="position"/>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="overlay" id="modalOverlay" style="display: none;">
<div class="modal-content">
<p>Login or sign up disabled while the site is in read only mode</p>
<hr/>
<button class="btn btn-login">OK</button>
</div>
</div>
<script src="../../js/script.js"></script>
</body>
</html>