<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="../../css/checklist_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_theme_2_be4cb2b86ec06123c5e974acd20fd933d14b129d.css" rel="stylesheet"/>
<link href="../../css/discourse-adplugin_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-akismet_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-cakeday_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-chat-integration_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-details_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-footnote_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-lazy-videos_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-local-dates_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/color_definitions_base__2_8fd59ae1f286f43b3ff17996df07ea951685249d.css" rel="stylesheet"/>
<link href="../../css/style.css" rel="stylesheet"/>
<title>Upgrade Celery to 4.x</title></head>
<body>
<div class="navbar">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<div class="navbar-buttons">
<button class="btn btn-signup">Sign Up</button>
<button class="btn btn-login"><i class="fas fa-user"></i> Login</button>
<button class="btn btn-search"><i class="fas fa-search"></i></button>
<div class="navbar-toggle">
<div class="dots"></div>
<div class="dots"></div>
<div class="dots"></div>
</div>
</div>
</div>
<div class="sidebar">
<div class="sidebar-content">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<ul class="sidebar-grid">
<!-- <li><a href="#"><i class="fas fa-list-ul"></i> Topics</a></li> -->
<li><a href="../../page_0.html"><i class="fas fa-layer-group"></i> Topics</a></li>
<li><a href="../../users.html"><i class="fas fa-users"></i> Users</a></li>
<li><a href="../../about.html"><i class="fas fa-info-circle"></i> About</a></li>
<li><a href="../../faq.html"><i class="fas fa-question-circle"></i> FAQ</a></li>
<li><a href="../../groups.html"><i class="fas fa-users"></i> Groups</a></li>
<li><a href="../../badges.html"><i class="fas fa-certificate"></i> Badges</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#categories"><span>▼</span>Categories</a></h3>
<hr/>
<ul class="sidebar-grid categories">
<li>
<a class="badge-wrapper bullet" href="../../c/support/6.html">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name">Support</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/feature-requests/5.html">
<span class="badge-category-bg" style="background-color: #3AB54A"></span>
<span class="badge-category clear-badge">
<span class="category-name">Feature Requests</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/uncategorized/1.html">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name">Uncategorized</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/development/7.html">
<span class="badge-category-bg" style="background-color: #8C6238"></span>
<span class="badge-category clear-badge">
<span class="category-name">Development</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/tips-tricks-query-examples/11.html">
<span class="badge-category-bg" style="background-color: #652D90"></span>
<span class="badge-category clear-badge" style="white-space: normal;">
<span class="category-name">Tips, Tricks &amp; Query Examples</span>
</span>
</a>
</li>
<li><a href="../../categories.html"><i class="fas fa-list-ul"></i> All categories</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#tags"><span>▼</span>Tags</a></h3>
<hr/>
<ul class="sidebar-grid tags">
<li><a href="../../tag/query_results.html"><i class="fas fa-tag"></i> query_results</a></li>
<li><a href="../../tag/feature-request.html"><i class="fas fa-tag"></i> feature-request</a></li>
<li><a href="../../tag/parameters.html"><i class="fas fa-tag"></i> parameters</a></li>
<li><a href="../../tag/visualizations.html"><i class="fas fa-tag"></i> visualizations</a></li>
<li><a href="../../tag/alerts.html"><i class="fas fa-tag"></i> alerts</a></li>
<li><a href="../../tags.html"><i class="fas fa-list-ul"></i> All tags</a></li>
</ul>
</div>
<div class="sidebar-footer">
            © 2023 <a href="https://discuss.redash.io/" target="_blank">discuss.redash.io</a>
</div>
</div>
<div class="overlay"></div>
<div class="content">
<div class="global-notice">
<div class="row">
<div class="alert alert-info alert-read-only" id="global-notice-alert-read-only">
<span class="text">This site is in read only mode. Please continue to browse, but replying, likes,
                        and other actions are disabled for now.</span>
</div>
</div>
</div>
<div class="imported_page" id="imported_page">
<div class="wrap" id="main-outlet" role="main">
<div id="topic-title">
<h1>
<a href="/t/upgrade-celery-to-4-x/1867">Upgrade Celery to 4.x</a>
</h1>
<div class="topic-category" itemscope="" itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/development/7.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #8C6238"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Development</span>
</span>
</a>
<meta content="1" itemprop="position"/>
</span>
</div>
</div>
<div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
<meta content="Upgrade Celery to 4.x" itemprop="headline"/>
<meta content="Development" itemprop="articleSection"/>
<meta content="" itemprop="keywords"/>
<div itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
<meta content="Redash Discourse" itemprop="name"/>
<div itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject">
<meta content="https://global.discourse-cdn.com/standard17/uploads/redash1/original/1X/c07bc573841e1e4a0013ea3b6fe088a1534228a3.png" itemprop="url"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_1">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/atharvai.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/atharvai_avatar.png" tabindex="-1" width="48"/><span itemprop="name">atharvai</span></a>
</span>
<link href="https://discuss.redash.io/t/upgrade-celery-to-4-x/1867" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2018-05-04T09:04:23Z" itemprop="datePublished">
                    May 4, 2018,  9:04am
                  </time>
<meta content="2018-05-04T09:04:23Z" itemprop="dateModified"/>
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<h2>Why am I suggesting this?</h2>
<p>We at Hudl self-host the OSS version of Redash. v3. We consistently see one bad query returning large data set use the entire memory of the server affecting other workers and queries. Currently Celery v3.x does not allow adding memory usage limits (<code>--max-memory-per-child</code> flag). However, Celery v4.x does. We would like to use this to isolate and limit contention between celery workers.</p>
<p>This issue exists for Redash v4 too as the celery version is the same major version.</p>
<h2>What needs to be done?</h2>
<p>To limit contention of resources between Celery workers is to limit how much memory gets used by each worker. One way to do this is to upgrade version of Celery to v4.x. This is not a trivial change however. Here’s what’s changed in celery between v3 and v4: <a href="http://docs.celeryproject.org/en/master/whatsnew-4.0.html" rel="nofollow noopener">http://docs.celeryproject.org/en/master/whatsnew-4.0.html</a></p>
<p>There are changes to interfaces, routing, redis events, and dropped support for few old frameworks, etc. This is probably a large update to the backend and could be phased. The lazy upgrade is to update python package and any decorators and function signatures. This is only to be done in small number of places but testing will be important.</p>
<p>There will be a lot more changes to do such as changing setting names, function signatures, etc.</p>
<h2>Next Steps</h2>
<p>The main aim is to use this as a discussion thread. If there are ways to limit the impact of upgrade, I’d like to hear this, If there are ways that don’t require an upgrade to Celery or the owners and community don’t want to upgrade celery, I’d like to find other ways.</p>
<p>I know parts of the codebase but not everything so I’m looking for help identifying list of changes to be done.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_2" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/arikfr.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/arikfr_avatar.png" tabindex="-1" width="48"/><span itemprop="name">arikfr</span></a>
</span>
<link href="https://discuss.redash.io/t/upgrade-celery-to-4-x/1867" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2018-05-04T10:22:09Z" itemprop="datePublished">
                    May 4, 2018, 10:22am
                  </time>
<meta content="2018-05-04T10:22:09Z" itemprop="dateModified"/>
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I’m all for upgrading Celery <img alt=":+1:" class="emoji" src="assets/+1.png" title=":+1:"/> , but as you said we need to do so carefully. I think that most of the changes don’t affect us, except for name changes of some of the settings, that we will need to update.</p>
<p>The folks from Mozilla already use Celery 4 with Redash, so we can try and check what they did. Unfortunately I’m not sure if any of them are on the forum <img alt=":man_shrugging:" class="emoji" src="assets/man_shrugging.png" title=":man_shrugging:"/></p>
<p>The other concern is how will it work when during an actual upgrade if the user still has jobs from Celery 3.x. V4  already using a version of Celery that should be forward compatible, <em>but</em> not all users will upgrade from V4. The least we should have is clear instructions on what to do (probably clear Redis).</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_3" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/atharvai.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/atharvai_avatar.png" tabindex="-1" width="48"/><span itemprop="name">atharvai</span></a>
</span>
<link href="https://discuss.redash.io/t/upgrade-celery-to-4-x/1867" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2018-05-04T10:29:23Z" itemprop="datePublished">
                    May 4, 2018, 10:29am
                  </time>
<meta content="2018-05-04T10:29:23Z" itemprop="dateModified"/>
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>It would be good to hear about Mozilla’s experience. Do they maintain their work fork then?</p>
<p>For upgrades, for the settings, we could have a small script that does the conversion. Some other changes that affect redash is adding <code>typing=False</code> to task decorator for not using function signatures. although we could do without it (I need to spend time on reading how celery does this). And secondly adding <code>**kwargs</code> to function parameters for all tasks.</p>
<p>I’ll start my investigation on this and document in this thread what changes we need in addition to above.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_4" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/arikfr.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/arikfr_avatar.png" tabindex="-1" width="48"/><span itemprop="name">arikfr</span></a>
</span>
<link href="https://discuss.redash.io/t/upgrade-celery-to-4-x/1867" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2018-05-04T11:00:27Z" itemprop="datePublished">
                    May 4, 2018, 11:00am
                  </time>
<meta content="2018-05-04T11:00:27Z" itemprop="dateModified"/>
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Yes their fork is here: <a href="http://github.com/mozilla/redash">github.com/mozilla/redash</a>.</p>
<p>We can move the discussion to a GitHub issue, and then mention them to bring them to the discussion <img alt=":slight_smile:" class="emoji" src="assets/slight_smile.png" title=":slight_smile:"/></p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_5" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/atharvai.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/atharvai_avatar.png" tabindex="-1" width="48"/><span itemprop="name">atharvai</span></a>
</span>
<link href="https://discuss.redash.io/t/upgrade-celery-to-4-x/1867" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2018-05-04T12:19:20Z" itemprop="datePublished">
                    May 4, 2018, 12:19pm
                  </time>
<meta content="2018-05-04T12:19:20Z" itemprop="dateModified"/>
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I added the Github issue at <a href="https://github.com/getredash/redash/issues/2517" rel="nofollow noopener">https://github.com/getredash/redash/issues/2517</a></p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_6" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/atharvai.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/atharvai_avatar.png" tabindex="-1" width="48"/><span itemprop="name">atharvai</span></a>
</span>
<link href="https://discuss.redash.io/t/upgrade-celery-to-4-x/1867" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2018-05-04T12:30:48Z" itemprop="datePublished">
                    May 4, 2018, 12:30pm
                  </time>
<meta content="2018-05-04T12:30:48Z" itemprop="dateModified"/>
<span itemprop="position">6</span>
</span>
</div>
<div class="post" itemprop="text">
<p>From Mozilla’s fork it looks like they have a commit for upgrade <a href="https://github.com/mozilla/redash/commit/de4a5a1419902953146a12efbea6e17776b6e5d6" rel="nofollow noopener">https://github.com/mozilla/redash/commit/de4a5a1419902953146a12efbea6e17776b6e5d6</a></p>
<p>Doesn’t look too bad.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="overlay" id="modalOverlay" style="display: none;">
<div class="modal-content">
<p>Login or sign up disabled while the site is in read only mode</p>
<hr/>
<button class="btn btn-login">OK</button>
</div>
</div>
<script src="../../js/script.js"></script>
</body>
</html>