<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="../../css/checklist_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_theme_2_be4cb2b86ec06123c5e974acd20fd933d14b129d.css" rel="stylesheet"/>
<link href="../../css/discourse-adplugin_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-akismet_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-cakeday_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-chat-integration_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-details_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-footnote_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-lazy-videos_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-local-dates_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/color_definitions_base__2_8fd59ae1f286f43b3ff17996df07ea951685249d.css" rel="stylesheet"/>
<link href="../../css/style.css" rel="stylesheet"/>
<title>Restoring Redash from backup - personal journey</title></head>
<body>
<div class="navbar">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<div class="navbar-buttons">
<button class="btn btn-signup">Sign Up</button>
<button class="btn btn-login"><i class="fas fa-user"></i> Login</button>
<button class="btn btn-search"><i class="fas fa-search"></i></button>
<div class="navbar-toggle">
<div class="dots"></div>
<div class="dots"></div>
<div class="dots"></div>
</div>
</div>
</div>
<div class="sidebar">
<div class="sidebar-content">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<ul class="sidebar-grid">
<!-- <li><a href="#"><i class="fas fa-list-ul"></i> Topics</a></li> -->
<li><a href="../../page_0.html"><i class="fas fa-layer-group"></i> Topics</a></li>
<li><a href="../../users.html"><i class="fas fa-users"></i> Users</a></li>
<li><a href="../../about.html"><i class="fas fa-info-circle"></i> About</a></li>
<li><a href="../../faq.html"><i class="fas fa-question-circle"></i> FAQ</a></li>
<li><a href="../../groups.html"><i class="fas fa-users"></i> Groups</a></li>
<li><a href="../../badges.html"><i class="fas fa-certificate"></i> Badges</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#categories"><span>▼</span>Categories</a></h3>
<hr/>
<ul class="sidebar-grid categories">
<li>
<a class="badge-wrapper bullet" href="../../c/support/6.html">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name">Support</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/feature-requests/5.html">
<span class="badge-category-bg" style="background-color: #3AB54A"></span>
<span class="badge-category clear-badge">
<span class="category-name">Feature Requests</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/uncategorized/1.html">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name">Uncategorized</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/development/7.html">
<span class="badge-category-bg" style="background-color: #8C6238"></span>
<span class="badge-category clear-badge">
<span class="category-name">Development</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/tips-tricks-query-examples/11.html">
<span class="badge-category-bg" style="background-color: #652D90"></span>
<span class="badge-category clear-badge" style="white-space: normal;">
<span class="category-name">Tips, Tricks &amp; Query Examples</span>
</span>
</a>
</li>
<li><a href="../../categories.html"><i class="fas fa-list-ul"></i> All categories</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#tags"><span>▼</span>Tags</a></h3>
<hr/>
<ul class="sidebar-grid tags">
<li><a href="../../tag/query_results.html"><i class="fas fa-tag"></i> query_results</a></li>
<li><a href="../../tag/feature-request.html"><i class="fas fa-tag"></i> feature-request</a></li>
<li><a href="../../tag/parameters.html"><i class="fas fa-tag"></i> parameters</a></li>
<li><a href="../../tag/visualizations.html"><i class="fas fa-tag"></i> visualizations</a></li>
<li><a href="../../tag/alerts.html"><i class="fas fa-tag"></i> alerts</a></li>
<li><a href="../../tags.html"><i class="fas fa-list-ul"></i> All tags</a></li>
</ul>
</div>
<div class="sidebar-footer">
            © 2023 <a href="https://discuss.redash.io/" target="_blank">discuss.redash.io</a>
</div>
</div>
<div class="overlay"></div>
<div class="content">
<div class="global-notice">
<div class="row">
<div class="alert alert-info alert-read-only" id="global-notice-alert-read-only">
<span class="text">This site is in read only mode. Please continue to browse, but replying, likes,
                        and other actions are disabled for now.</span>
</div>
</div>
</div>
<div class="imported_page" id="imported_page">
<div class="wrap" id="main-outlet" role="main">
<div id="topic-title">
<h1>
<a href="/t/restoring-redash-from-backup-personal-journey/5299">Restoring Redash from backup - personal journey</a>
</h1>
<div class="topic-category" itemscope="" itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/support/6.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Support</span>
</span>
</a>
<meta content="1" itemprop="position"/>
</span>
</div>
</div>
<div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
<meta content="Restoring Redash from backup - personal journey" itemprop="headline"/>
<meta content="Support" itemprop="articleSection"/>
<meta content="" itemprop="keywords"/>
<div itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
<meta content="Redash Discourse" itemprop="name"/>
<div itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject">
<meta content="https://global.discourse-cdn.com/standard17/uploads/redash1/original/1X/c07bc573841e1e4a0013ea3b6fe088a1534228a3.png" itemprop="url"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_1">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/m1keil.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/m1keil_avatar.png" tabindex="-1" width="48"/><span itemprop="name">m1keil</span></a>
</span>
<link href="https://discuss.redash.io/t/restoring-redash-from-backup-personal-journey/5299" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-01-09T07:28:57Z" itemprop="datePublished">
                    January 9, 2020,  7:28am
                  </time>
<meta content="2020-01-09T07:28:57Z" itemprop="dateModified"/>
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>We had an incident the other day as a result of we lost our Redash EC2 instance. I’ve spent the last half a day attempting to restore it. I thought I should probably share this with the rest of the community as a part feedback and part tips and tricks for the benefit of anyone else that might have to deal with such a problem.</p>
<p>The first problem I’ve stumbled upon is that Redash doesn’t really provide any instructions regarding how to restore from backup. The admin guide is pretty short and only mentions how to take a DB dump but not how to restore it. Looking around the discussions over here, I’ve gathered some pointers about how to act but the general advice is to follow the instructions for Postgres backup restore.<br/>
Very helpful was the message from <a class="mention" href="/u/warmice">@warmice</a> in this <a href="http://discuss.redash.io/t/db-backup-of-self-hosted-redash/3665">thread</a>.<br/>
In general it was pretty disappointing to see such a complete lack of clarity about restore procedure.</p>
<hr/>
<p>The next problem was that we were trying to restore a backup from an instance that was installed and configured in a different way to how it is done on the latest official AMI. The old Redash instance was installed from the bootstrap.sh script (v3-v4) and upgraded as time went on. As a result, the db owner was actually “redash” user and not “postgres”. This introduced another round of complications for someone who’s not familiar with DB recovery. Moreover, I wasn’t even sure which version we had installed (I was not the one who installed it).</p>
<p>When attempting to restore the backup via <code>psql</code>, I would get multiple errors that looked like <code>role "redash" does not exist</code>. Grepping the SQL backup I figured it’s probably because that all the create table statements have “TO OWNER redash” in the end. While I toyed around with the idea of just changing it to <code>postgres</code>, I wasn’t sure if that would just work.<br/>
Instead I followed the instructions I’ve <a href="https://stackoverflow.com/questions/40632228/input-file-appears-to-be-a-text-format-dump-please-use-psql" rel="nofollow noopener">found on stackoverflow</a> and converted the backup from plaintext format to custom. This would allow me to use <em>pg_restore</em> and let it handle the owner issue:</p>
<p><code>cat db.dump | docker exec -i redash_postgres_1 pg_restore --clean --if-exists --no-acl  --no-owner -U postgres -d postgres</code></p>
<p>Tips:</p>
<ol>
<li>Make sure to write down the exact version of redash next to your db backup.</li>
<li>Try to recover on a similar setup if you can</li>
<li>Take backups in custom format instead of plain sql.</li>
</ol>
<hr/>
<p>Lastly, Redash introduced the <em>SECRET_KEY</em> property which encodes certain sensitive DB fields. However, to my knowledge, there is no advice anywhere in the admin guide or the docs about the necessity to backup this key. As a result I was stuck with restored DB with no access to the data sources config. In theory it shouldn’t be a big problem if you have these details saved in a seperate place. <strong>However the UI won’t load if the key is incorrect</strong>, blocking you from overwriting the data sources details.</p>
<p>To solve this issue:</p>
<ul>
<li>Set <em>SECRET_KEY</em> to whatever value you want. <strong>Save it next to your backup.</strong> In fact, backup your /opt/redash/env as well.</li>
<li>Wipe and re-create the db</li>
<li>Login into redash and create your data sources.</li>
<li>Copy the content of the <code>data_source</code> table, specifically, <code>encrypted_options</code> is what you care the most</li>
<li>Clear db again, restore backup and manually update the <code>data_sources</code> table.</li>
</ul>
<p>Hopefully it will be helpful for some people. I also hope that in the future versions of Redash there will be easier way to restore from backup.</p>
<p>Cheers.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="2" itemprop="userInteractionCount"/>
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
<div class="crawler-linkback-list" itemscope="" itemtype="http://schema.org/ItemList">
<div itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a href="http://discuss.redash.io/t/redash-migration-from-0-11-version-to-8-version/7421" itemprop="url">Redash migration from 0.11.*.* version to 8 version</a>
<meta content="3" itemprop="position"/>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="overlay" id="modalOverlay" style="display: none;">
<div class="modal-content">
<p>Login or sign up disabled while the site is in read only mode</p>
<hr/>
<button class="btn btn-login">OK</button>
</div>
</div>
<script src="../../js/script.js"></script>
</body>
</html>