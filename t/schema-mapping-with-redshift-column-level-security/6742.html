<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="../../css/checklist_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_theme_2_be4cb2b86ec06123c5e974acd20fd933d14b129d.css" rel="stylesheet"/>
<link href="../../css/discourse-adplugin_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-akismet_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-cakeday_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-chat-integration_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-details_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-footnote_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-lazy-videos_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-local-dates_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/color_definitions_base__2_8fd59ae1f286f43b3ff17996df07ea951685249d.css" rel="stylesheet"/>
<link href="../../css/style.css" rel="stylesheet"/>
<title>Schema mapping with Redshift column level security</title></head>
<body>
<div class="navbar">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<div class="navbar-buttons">
<button class="btn btn-signup">Sign Up</button>
<button class="btn btn-login"><i class="fas fa-user"></i> Login</button>
<button class="btn btn-search"><i class="fas fa-search"></i></button>
<div class="navbar-toggle">
<div class="dots"></div>
<div class="dots"></div>
<div class="dots"></div>
</div>
</div>
</div>
<div class="sidebar">
<div class="sidebar-content">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<ul class="sidebar-grid">
<!-- <li><a href="#"><i class="fas fa-list-ul"></i> Topics</a></li> -->
<li><a href="../../page_0.html"><i class="fas fa-layer-group"></i> Topics</a></li>
<li><a href="../../users.html"><i class="fas fa-users"></i> Users</a></li>
<li><a href="../../about.html"><i class="fas fa-info-circle"></i> About</a></li>
<li><a href="../../faq.html"><i class="fas fa-question-circle"></i> FAQ</a></li>
<li><a href="../../groups.html"><i class="fas fa-users"></i> Groups</a></li>
<li><a href="../../badges.html"><i class="fas fa-certificate"></i> Badges</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#categories"><span>▼</span>Categories</a></h3>
<hr/>
<ul class="sidebar-grid categories">
<li>
<a class="badge-wrapper bullet" href="../../c/support/6.html">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name">Support</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/feature-requests/5.html">
<span class="badge-category-bg" style="background-color: #3AB54A"></span>
<span class="badge-category clear-badge">
<span class="category-name">Feature Requests</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/uncategorized/1.html">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name">Uncategorized</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/development/7.html">
<span class="badge-category-bg" style="background-color: #8C6238"></span>
<span class="badge-category clear-badge">
<span class="category-name">Development</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/tips-tricks-query-examples/11.html">
<span class="badge-category-bg" style="background-color: #652D90"></span>
<span class="badge-category clear-badge" style="white-space: normal;">
<span class="category-name">Tips, Tricks &amp; Query Examples</span>
</span>
</a>
</li>
<li><a href="../../categories.html"><i class="fas fa-list-ul"></i> All categories</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#tags"><span>▼</span>Tags</a></h3>
<hr/>
<ul class="sidebar-grid tags">
<li><a href="../../tag/query_results.html"><i class="fas fa-tag"></i> query_results</a></li>
<li><a href="../../tag/feature-request.html"><i class="fas fa-tag"></i> feature-request</a></li>
<li><a href="../../tag/parameters.html"><i class="fas fa-tag"></i> parameters</a></li>
<li><a href="../../tag/visualizations.html"><i class="fas fa-tag"></i> visualizations</a></li>
<li><a href="../../tag/alerts.html"><i class="fas fa-tag"></i> alerts</a></li>
<li><a href="../../tags.html"><i class="fas fa-list-ul"></i> All tags</a></li>
</ul>
</div>
<div class="sidebar-footer">
            © 2023 <a href="https://discuss.redash.io/" target="_blank">discuss.redash.io</a>
</div>
</div>
<div class="overlay"></div>
<div class="content">
<div class="global-notice">
<div class="row">
<div class="alert alert-info alert-read-only" id="global-notice-alert-read-only">
<span class="text">This site is in read only mode. Please continue to browse, but replying, likes,
                        and other actions are disabled for now.</span>
</div>
</div>
</div>
<div class="imported_page" id="imported_page">
<div class="wrap" id="main-outlet" role="main">
<div id="topic-title">
<h1>
<a href="/t/schema-mapping-with-redshift-column-level-security/6742">Schema mapping with Redshift column level security</a>
</h1>
<div class="topic-category" itemscope="" itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/support/6.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Support</span>
</span>
</a>
<meta content="1" itemprop="position"/>
</span>
</div>
</div>
<div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
<meta content="Schema mapping with Redshift column level security" itemprop="headline"/>
<meta content="Support" itemprop="articleSection"/>
<meta content="" itemprop="keywords"/>
<div itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
<meta content="Redash Discourse" itemprop="name"/>
<div itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject">
<meta content="https://global.discourse-cdn.com/standard17/uploads/redash1/original/1X/c07bc573841e1e4a0013ea3b6fe088a1534228a3.png" itemprop="url"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_1">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/mfrye.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/mfrye_avatar.png" tabindex="-1" width="48"/><span itemprop="name">mfrye</span></a>
</span>
<link href="https://discuss.redash.io/t/schema-mapping-with-redshift-column-level-security/6742" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-07-13T19:45:13Z" itemprop="datePublished">
                    July 13, 2020,  7:45pm
                  </time>
<meta content="2020-07-13T19:45:13Z" itemprop="dateModified"/>
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>Hey there,</p>
<p>Our team has been using Redash internally for awhile now. Thank you for the awesome product.</p>
<p>We recently switched over to use <a href="https://docs.aws.amazon.com/redshift/latest/dg/r_GRANT.html#r_GRANT-usage-notes-clp" rel="nofollow noopener">Redshift column level security</a>, which enables granting “select” access to a specific subset of columns in a table. It looks like this breaks the schema mapping functions in Redash though, as none of the tables setup from the new schema with column level security are showing up in the Redash UI.</p>
<p>Is there a potential workaround for this, or would this require adding a fix in the Redash code to support this?</p>
<ul>
<li>Michael</li>
</ul>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_2" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/k4s1m.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/k4s1m_avatar.png" tabindex="-1" width="48"/><span itemprop="name">k4s1m</span></a>
</span>
<link href="https://discuss.redash.io/t/schema-mapping-with-redshift-column-level-security/6742" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-07-14T11:30:23Z" itemprop="datePublished">
                    July 14, 2020, 11:30am
                  </time>
<meta content="2020-07-14T11:30:23Z" itemprop="dateModified"/>
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I don’t know Redshift very well. But I think it behaves like Postgres and uses the <code>pg.py</code> query runner:</p>
<aside class="onebox githubblob">
<header class="source">
<a href="https://github.com/getredash/redash/blob/81e7c72d48e6715e10a820c7fc97cf215d8bbd19/redash/query_runner/pg.py#L80-L107" rel="nofollow noopener" target="_blank">github.com</a>
</header>
<article class="onebox-body">
<h4><a href="https://github.com/getredash/redash/blob/81e7c72d48e6715e10a820c7fc97cf215d8bbd19/redash/query_runner/pg.py#L80-L107" rel="nofollow noopener" target="_blank">getredash/redash/blob/81e7c72d48e6715e10a820c7fc97cf215d8bbd19/redash/query_runner/pg.py#L80-L107</a></h4>
<pre class="onebox"><code class="lang-py"><ol class="start lines" start="80" style="counter-reset: li-counter 79 ;">
<li>def build_schema(query_result, schema):</li>
<li>    # By default we omit the public schema name from the table name. But there are</li>
<li>    # edge cases, where this might cause conflicts. For example:</li>
<li>    # * We have a schema named "main" with table "users".</li>
<li>    # * We have a table named "main.users" in the public schema.</li>
<li>    # (while this feels unlikely, this actually happened)</li>
<li>    # In this case if we omit the schema name for the public table, we will have</li>
<li>    # a conflict.</li>
<li>    table_names = set(</li>
<li>        map(</li>
<li>            lambda r: full_table_name(r["table_schema"], r["table_name"]),</li>
<li>            query_result["rows"],</li>
<li>        )</li>
<li>    )</li>
<li>
</li><li>    for row in query_result["rows"]:</li>
<li>        if row["table_schema"] != "public":</li>
<li>            table_name = full_table_name(row["table_schema"], row["table_name"])</li>
<li>        else:</li>
<li>            if row["table_name"] in table_names:</li>
</ol></code></pre>

  This file has been truncated. <a href="https://github.com/getredash/redash/blob/81e7c72d48e6715e10a820c7fc97cf215d8bbd19/redash/query_runner/pg.py#L80-L107" rel="nofollow noopener" target="_blank">show original</a>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
<p>This code builds the schema. Maybe an answer is apparent? I assume that if your permissions are set properly in Redshift then the schema will appear in Redash. Have you double-checked? If so, you might need to edit this Python file.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_3" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/mfrye.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/mfrye_avatar.png" tabindex="-1" width="48"/><span itemprop="name">mfrye</span></a>
</span>
<link href="https://discuss.redash.io/t/schema-mapping-with-redshift-column-level-security/6742" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-07-14T15:35:32Z" itemprop="datePublished">
                    July 14, 2020,  3:35pm
                  </time>
<meta content="2020-07-14T15:35:32Z" itemprop="dateModified"/>
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Thanks for getting back to me. Yes, you’re correct in that Redshift is based on Postgres.</p>
<p>I figured out the specific code that is causing the issue:<br/>
</p><aside class="onebox githubblob">
<header class="source">
<a href="https://github.com/getredash/redash/blob/81e7c72d48e6715e10a820c7fc97cf215d8bbd19/redash/query_runner/pg.py#L372-L403" rel="nofollow noopener" target="_blank">github.com</a>
</header>
<article class="onebox-body">
<h4><a href="https://github.com/getredash/redash/blob/81e7c72d48e6715e10a820c7fc97cf215d8bbd19/redash/query_runner/pg.py#L372-L403" rel="nofollow noopener" target="_blank">getredash/redash/blob/81e7c72d48e6715e10a820c7fc97cf215d8bbd19/redash/query_runner/pg.py#L372-L403</a></h4>
<pre class="onebox"><code class="lang-py"><ol class="start lines" start="372" style="counter-reset: li-counter 371 ;">
<li>def _get_tables(self, schema):</li>
<li>    # Use svv_columns to include internal &amp; external (Spectrum) tables and views data for Redshift</li>
<li>    # https://docs.aws.amazon.com/redshift/latest/dg/r_SVV_COLUMNS.html</li>
<li>    # Use HAS_SCHEMA_PRIVILEGE(), SVV_EXTERNAL_SCHEMAS and HAS_TABLE_PRIVILEGE() to filter</li>
<li>    # out tables the current user cannot access.</li>
<li>    # https://docs.aws.amazon.com/redshift/latest/dg/r_HAS_SCHEMA_PRIVILEGE.html</li>
<li>    # https://docs.aws.amazon.com/redshift/latest/dg/r_SVV_EXTERNAL_SCHEMAS.html</li>
<li>    # https://docs.aws.amazon.com/redshift/latest/dg/r_HAS_TABLE_PRIVILEGE.html</li>
<li>    query = """</li>
<li>    WITH tables AS (</li>
<li>        SELECT DISTINCT table_name,</li>
<li>                        table_schema,</li>
<li>                        column_name,</li>
<li>                        ordinal_position AS pos</li>
<li>        FROM svv_columns</li>
<li>        WHERE table_schema NOT IN ('pg_internal','pg_catalog','information_schema')</li>
<li>        AND table_schema NOT LIKE 'pg_temp_%'</li>
<li>    )</li>
<li>    SELECT table_name, table_schema, column_name</li>
<li>    FROM tables</li>
</ol></code></pre>

  This file has been truncated. <a href="https://github.com/getredash/redash/blob/81e7c72d48e6715e10a820c7fc97cf215d8bbd19/redash/query_runner/pg.py#L372-L403" rel="nofollow noopener" target="_blank">show original</a>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
<p>Specifically, this block here:<br/>
</p><aside class="onebox githubblob">
<header class="source">
<a href="https://github.com/getredash/redash/blob/81e7c72d48e6715e10a820c7fc97cf215d8bbd19/redash/query_runner/pg.py#L392-L397" rel="nofollow noopener" target="_blank">github.com</a>
</header>
<article class="onebox-body">
<h4><a href="https://github.com/getredash/redash/blob/81e7c72d48e6715e10a820c7fc97cf215d8bbd19/redash/query_runner/pg.py#L392-L397" rel="nofollow noopener" target="_blank">getredash/redash/blob/81e7c72d48e6715e10a820c7fc97cf215d8bbd19/redash/query_runner/pg.py#L392-L397</a></h4>
<pre class="onebox"><code class="lang-py"><ol class="start lines" start="392" style="counter-reset: li-counter 391 ;">
<li>WHERE</li>
<li>    HAS_SCHEMA_PRIVILEGE(table_schema, 'USAGE') AND</li>
<li>    (</li>
<li>        table_schema IN (SELECT schemaname FROM SVV_EXTERNAL_SCHEMAS) OR</li>
<li>        HAS_TABLE_PRIVILEGE('"' || table_schema || '"."' || table_name || '"', 'SELECT')</li>
<li>    )</li>
</ol></code></pre>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
<p>Basically, Redshift doesn’t have an internal function for “partial” select grant queries. The default is <code>HAS_TABLE_PRIVILEGE()</code>, which only checks if the user has full “select” access to the table. Since the Redash user only has access to some of the columns, this function returns false and the schema doesn’t show up in the UI.</p>
<p>I’m not sure of what the best solution should be, but in the meantime, I figured out a rather hacky workaround to avoid touching / customizing the Redash code for us. I noticed that the block I mentioned above will return true if the table’s schema is listed as a Redshift external schema. So I hacked <code>SVV_EXTERNAL_SCHEMAS</code>, which is a view, to include the schema that won’t show up. I don’t know yet how stable this is, but the schema now shows in the UI.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_4" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/k4s1m.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/k4s1m_avatar.png" tabindex="-1" width="48"/><span itemprop="name">k4s1m</span></a>
</span>
<link href="https://discuss.redash.io/t/schema-mapping-with-redshift-column-level-security/6742" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-07-14T15:48:37Z" itemprop="datePublished">
                    July 14, 2020,  3:48pm
                  </time>
<meta content="2020-07-14T15:48:37Z" itemprop="dateModified"/>
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Nice hack! Maybe the Redash code could be adjusted using a <code>CASE</code> for tables where column restrictions are in effect.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_5" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/mfrye.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/mfrye_avatar.png" tabindex="-1" width="48"/><span itemprop="name">mfrye</span></a>
</span>
<link href="https://discuss.redash.io/t/schema-mapping-with-redshift-column-level-security/6742" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-07-14T16:20:36Z" itemprop="datePublished">
                    July 14, 2020,  4:20pm
                  </time>
<meta content="2020-07-14T16:20:36Z" itemprop="dateModified"/>
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Thanks! Yeah, that’s possible. I haven’t been able to figure out a clean way to query Redshift though to detect if column restrictions are in effect.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="overlay" id="modalOverlay" style="display: none;">
<div class="modal-content">
<p>Login or sign up disabled while the site is in read only mode</p>
<hr/>
<button class="btn btn-login">OK</button>
</div>
</div>
<script src="../../js/script.js"></script>
</body>
</html>