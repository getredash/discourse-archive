<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="../../css/checklist_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_theme_2_be4cb2b86ec06123c5e974acd20fd933d14b129d.css" rel="stylesheet"/>
<link href="../../css/discourse-adplugin_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-akismet_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-cakeday_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-chat-integration_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-details_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-footnote_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-lazy-videos_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-local-dates_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/color_definitions_base__2_8fd59ae1f286f43b3ff17996df07ea951685249d.css" rel="stylesheet"/>
<link href="../../css/style.css" rel="stylesheet"/>
<title>Enforce to add partition key and limit clause</title></head>
<body>
<div class="navbar">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<div class="navbar-buttons">
<button class="btn btn-signup">Sign Up</button>
<button class="btn btn-login"><i class="fas fa-user"></i> Login</button>
<button class="btn btn-search"><i class="fas fa-search"></i></button>
<div class="navbar-toggle">
<div class="dots"></div>
<div class="dots"></div>
<div class="dots"></div>
</div>
</div>
</div>
<div class="sidebar">
<div class="sidebar-content">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<ul class="sidebar-grid">
<!-- <li><a href="#"><i class="fas fa-list-ul"></i> Topics</a></li> -->
<li><a href="../../page_0.html"><i class="fas fa-layer-group"></i> Topics</a></li>
<li><a href="../../users.html"><i class="fas fa-users"></i> Users</a></li>
<li><a href="../../about.html"><i class="fas fa-info-circle"></i> About</a></li>
<li><a href="../../faq.html"><i class="fas fa-question-circle"></i> FAQ</a></li>
<li><a href="../../groups.html"><i class="fas fa-users"></i> Groups</a></li>
<li><a href="../../badges.html"><i class="fas fa-certificate"></i> Badges</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#categories"><span>▼</span>Categories</a></h3>
<hr/>
<ul class="sidebar-grid categories">
<li>
<a class="badge-wrapper bullet" href="../../c/support/6.html">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name">Support</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/feature-requests/5.html">
<span class="badge-category-bg" style="background-color: #3AB54A"></span>
<span class="badge-category clear-badge">
<span class="category-name">Feature Requests</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/uncategorized/1.html">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name">Uncategorized</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/development/7.html">
<span class="badge-category-bg" style="background-color: #8C6238"></span>
<span class="badge-category clear-badge">
<span class="category-name">Development</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/tips-tricks-query-examples/11.html">
<span class="badge-category-bg" style="background-color: #652D90"></span>
<span class="badge-category clear-badge" style="white-space: normal;">
<span class="category-name">Tips, Tricks &amp; Query Examples</span>
</span>
</a>
</li>
<li><a href="../../categories.html"><i class="fas fa-list-ul"></i> All categories</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#tags"><span>▼</span>Tags</a></h3>
<hr/>
<ul class="sidebar-grid tags">
<li><a href="../../tag/query_results.html"><i class="fas fa-tag"></i> query_results</a></li>
<li><a href="../../tag/feature-request.html"><i class="fas fa-tag"></i> feature-request</a></li>
<li><a href="../../tag/parameters.html"><i class="fas fa-tag"></i> parameters</a></li>
<li><a href="../../tag/visualizations.html"><i class="fas fa-tag"></i> visualizations</a></li>
<li><a href="../../tag/alerts.html"><i class="fas fa-tag"></i> alerts</a></li>
<li><a href="../../tags.html"><i class="fas fa-list-ul"></i> All tags</a></li>
</ul>
</div>
<div class="sidebar-footer">
            © 2023 <a href="https://discuss.redash.io/" target="_blank">discuss.redash.io</a>
</div>
</div>
<div class="overlay"></div>
<div class="content">
<div class="global-notice">
<div class="row">
<div class="alert alert-info alert-read-only" id="global-notice-alert-read-only">
<span class="text">This site is in read only mode. Please continue to browse, but replying, likes,
                        and other actions are disabled for now.</span>
</div>
</div>
</div>
<div class="imported_page" id="imported_page">
<div class="wrap" id="main-outlet" role="main">
<div id="topic-title">
<h1>
<a href="/t/enforce-to-add-partition-key-and-limit-clause/7616">Enforce to add partition key and limit clause</a>
</h1>
<div class="topic-category" itemscope="" itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/feature-requests/5.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #3AB54A"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Feature Requests</span>
</span>
</a>
<meta content="1" itemprop="position"/>
</span>
</div>
<div class="topic-category">
<div class="discourse-tags list-tags">
<a class="discourse-tag" href="https://discuss.redash.io/feature-request" rel="tag">feature-request</a>
</div>
</div>
</div>
<div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
<meta content="Enforce to add partition key and limit clause" itemprop="headline"/>
<meta content="Feature Requests" itemprop="articleSection"/>
<meta content="feature-request" itemprop="keywords"/>
<div itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
<meta content="Redash Discourse" itemprop="name"/>
<div itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject">
<meta content="https://global.discourse-cdn.com/standard17/uploads/redash1/original/1X/c07bc573841e1e4a0013ea3b6fe088a1534228a3.png" itemprop="url"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_1">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/ytannai.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/ytannai_avatar.png" tabindex="-1" width="48"/><span itemprop="name">ytannai</span></a>
</span>
<link href="https://discuss.redash.io/t/enforce-to-add-partition-key-and-limit-clause/7616" itemprop="mainEntityOfPage"/>
<link href="https://global.discourse-cdn.com/standard17/uploads/redash1/original/2X/4/46a6315bc626ad5a8003c639c6ece588ade74b2e.png" itemprop="image"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-11-26T05:07:53Z" itemprop="datePublished">
                    November 26, 2020,  5:07am
                  </time>
<meta content="2020-11-26T05:07:53Z" itemprop="dateModified"/>
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>AWS Athena increases the usage fee depending on the amount of data loaded.<br/>
To control this, I’m adding the following patch:<br/>
If a table with a partition key set forces you to specify it in the where clause when referring to the table. SQL that violates this will be canceled before being submitted to Athena.</p>
<p>Similarly, I apply a patch to force all SQL to have a LIMIT clause to keep Redash’s memory usage below a certain level.</p>
<p>For example, add a checkbox to enforce the Partition Key in places like the attached image.<br/>
<div class="lightbox-wrapper"><a class="lightbox" data-download-href="/uploads/short-url/a4ZulalqiyoEVTKIqhkEb8qmIMK.png?dl=1" href="https://global.discourse-cdn.com/standard17/uploads/redash1/original/2X/4/46a6315bc626ad5a8003c639c6ece588ade74b2e.png" rel="noopener nofollow ugc" title="image"><img alt="image" data-base62-sha1="a4ZulalqiyoEVTKIqhkEb8qmIMK" data-small-upload="https://global.discourse-cdn.com/standard17/uploads/redash1/optimized/2X/4/46a6315bc626ad5a8003c639c6ece588ade74b2e_2_10x10.png" height="500" src="assets/46a6315bc626ad5a8003c639c6ece588ade74b2e_2_240x500.png" srcset="https://global.discourse-cdn.com/standard17/uploads/redash1/optimized/2X/4/46a6315bc626ad5a8003c639c6ece588ade74b2e_2_240x500.png, https://global.discourse-cdn.com/standard17/uploads/redash1/optimized/2X/4/46a6315bc626ad5a8003c639c6ece588ade74b2e_2_360x750.png 1.5x, https://global.discourse-cdn.com/standard17/uploads/redash1/optimized/2X/4/46a6315bc626ad5a8003c639c6ece588ade74b2e_2_480x1000.png 2x" width="240"/><div class="meta">
<svg aria-hidden="true" class="fa d-icon d-icon-far-image svg-icon"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">702×1462 46 KB</span><svg aria-hidden="true" class="fa d-icon d-icon-discourse-expand svg-icon"><use href="#discourse-expand"></use></svg>
</div></a></div></p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_2" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/kylashpriya.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/kylashpriya_avatar.png" tabindex="-1" width="48"/><span itemprop="name">kylashpriya</span></a>
</span>
<link href="https://discuss.redash.io/t/enforce-to-add-partition-key-and-limit-clause/7616" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-11-29T15:04:22Z" itemprop="datePublished">
                    November 29, 2020,  3:04pm
                  </time>
<meta content="2020-11-29T15:04:22Z" itemprop="dateModified"/>
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hello [ytannai],<br/>
Thanks t alot for your valuable info. I’m looking similar stuff for Redshift data source. We use Redshift as our primary data source and we expose data via redash to users. Quite often, people ignore limit clause and it blows up our memory. Could you please share some info if you have it!</p>
<p>Thanks in advance!</p>
<p>Thanks and Regards,<br/>
Kylasam N A</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_3" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/ytannai.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/ytannai_avatar.png" tabindex="-1" width="48"/><span itemprop="name">ytannai</span></a>
</span>
<link href="https://discuss.redash.io/t/enforce-to-add-partition-key-and-limit-clause/7616" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-11-30T03:47:27Z" itemprop="datePublished">
                    November 30, 2020,  3:47am
                  </time>
<meta content="2020-11-30T03:47:27Z" itemprop="dateModified"/>
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hi <a class="mention" href="/u/kylashpriya">@kylashpriya</a></p>
<p>Our primary data source is AWS Athena and was faced same issue with you.<br/>
There were some users that cause memory usage issue for redash because of fetch many rows (over 100k).<br/>
Consequently, some patches like below was applied to self hosted redash.</p>
<pre><code class="lang-python">def __check_limit(self, query):
    query = sqlparse.format(query, keyword_case='upper', identifier_case='lower')
    parsed = sqlparse.parse(query)
    select_flag = False
    limit_flag = False
    for t in parsed[0].tokens:
        if str(t) == 'SELECT':
            select_flag = True
        if str(t) == 'LIMIT':
            limit_flag = True
    if select_flag and limit_flag:
        return
    elif not select_flag:
        return
    elif select_flag and not limit_flag:
        raise Exception("required limit")
</code></pre>
<p>I posted same question to AWS Support. They saied that Athena and official libraries provide some feature to fix the problem:<br/>
For example, RowsToFetchPerBlock and UseResultsetStreaming in Athena JDBC Driver can control row counts.<br/>
Athena’s GetQUeryResults API can also control. (<a href="https://docs.aws.amazon.com/athena/latest/APIReference/API_GetQueryResults.html" rel="noopener nofollow ugc">doc</a>)<br/>
But redash (and related libraries) don’t use it.</p>
<p>I know the default row count is 1000 when LIMIT is absent in current redash, but some user writes a query with the large LIMIT count.<br/>
So I need the LIMIT count enforcing feature.</p>
<p>For Alternative, I try to write small proxy server to intercept LIMIT-less query just now.</p>
<p>Sorry for Athena only reply because we don’t use Redshift.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_4" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/kylashpriya.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/kylashpriya_avatar.png" tabindex="-1" width="48"/><span itemprop="name">kylashpriya</span></a>
</span>
<link href="https://discuss.redash.io/t/enforce-to-add-partition-key-and-limit-clause/7616" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2021-03-12T00:41:30Z" itemprop="datePublished">
                    March 12, 2021, 12:41am
                  </time>
<meta content="2021-03-12T00:41:30Z" itemprop="dateModified"/>
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p><a class="mention" href="/u/ytannai">@ytannai</a><br/>
Thanks a lot once again for your reply.</p>
<p>Could you please let me know in which redash module/code/script your custom logic was implemented? I shall try the same. Hope the way redash queries remains the same!</p>
<p>U was trying to add custom limit clause in /app/redash/query_runner/pg.py under the container [ 19b6d771c573        redash/redash:8.0.0.b32245   “/app/bin/docker-ent…”   8 months ago        Up 30 minutes       0.0.0.0:5000-&gt;5000/tcp        redash_server_1]  with the below logic,<br/>
def run_query(self, query, user):<br/>
connection = self._get_connection()<br/>
_wait(connection, timeout=10)</p>
<pre><code>    cursor = connection.cursor()

    try:
        if "LIMIT" not in query.upper():
            query_new = query + " LIMIT 10"
            print("New query is==&gt;",query_new)
            cursor.execute(query_new)
            _wait(connection)
</code></pre>
<p>but this doesn’t work! I’m still seeing tonnes of records in the query window!<br/>
Any small help from you would be a life saver!</p>
<p>Thanks a lot in advance and wish you a fantastic Friday!</p>
<p>Thanks and Regards,<br/>
Kylash N A</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_5" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/griffinator76.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/griffinator76_avatar.png" tabindex="-1" width="48"/><span itemprop="name">griffinator76</span></a>
</span>
<link href="https://discuss.redash.io/t/enforce-to-add-partition-key-and-limit-clause/7616" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2021-03-12T03:25:39Z" itemprop="datePublished">
                    March 12, 2021,  3:25am
                  </time>
<meta content="2021-03-12T03:25:39Z" itemprop="dateModified"/>
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p><a class="mention" href="/u/kylashpriya">@kylashpriya</a> Hi, you may want to read up on how the <code>LIMIT</code> clause works in Redshift. Using this clause limits the number of rows returned to the user, but not necessarily the amount of data scanned by the query.<br/>
You may want to look at trying to ensure all queries contain a <code>WHERE</code> clause as people running queries without that has been a major issue I’ve seen in previous projects.<br/>
In my experience it’s really hard to prevent poorly educated users from constructing badly performing queries or queries that return enormous result sets. Education of users is definitely a worthwhile effort as well!</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_6" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/kylashpriya.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/kylashpriya_avatar.png" tabindex="-1" width="48"/><span itemprop="name">kylashpriya</span></a>
</span>
<link href="https://discuss.redash.io/t/enforce-to-add-partition-key-and-limit-clause/7616" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2021-03-12T07:33:11Z" itemprop="datePublished">
                    March 12, 2021,  7:33am
                  </time>
<meta content="2021-03-12T07:33:11Z" itemprop="dateModified"/>
<span itemprop="position">6</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hello [ytannai],<br/>
Once again, thanks a ton for your help. I was intended to do adding explicit limit even before querying at Redshift. So the query from redash UI needs to be tweaked before firing at Redshift.</p>
<p>Can’t agree more on educating users. But it seems not to be working fine. Since most of them ran query without thinking much, we have been trying educating for last one year which is super hard now. So we have to educate them via strict rules.<br/>
In the other hand, if you have some options for configuring some cache cleaning techniques or optimisation, please do share it with me. We shall try that as well.</p>
<p>Last but not least; will continue educating the users.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="overlay" id="modalOverlay" style="display: none;">
<div class="modal-content">
<p>Login or sign up disabled while the site is in read only mode</p>
<hr/>
<button class="btn btn-login">OK</button>
</div>
</div>
<script src="../../js/script.js"></script>
</body>
</html>