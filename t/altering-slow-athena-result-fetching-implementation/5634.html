<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="../../css/checklist_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/desktop_theme_2_be4cb2b86ec06123c5e974acd20fd933d14b129d.css" rel="stylesheet"/>
<link href="../../css/discourse-adplugin_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-akismet_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-cakeday_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-chat-integration_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-details_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-footnote_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-lazy-videos_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/discourse-local-dates_d86c892d7cd5311243d31a8f11787f4b0342874d.css" rel="stylesheet"/>
<link href="../../css/color_definitions_base__2_8fd59ae1f286f43b3ff17996df07ea951685249d.css" rel="stylesheet"/>
<link href="../../css/style.css" rel="stylesheet"/>
<title>Altering slow athena result fetching implementation</title></head>
<body>
<div class="navbar">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<div class="navbar-buttons">
<button class="btn btn-signup">Sign Up</button>
<button class="btn btn-login"><i class="fas fa-user"></i> Login</button>
<button class="btn btn-search"><i class="fas fa-search"></i></button>
<div class="navbar-toggle">
<div class="dots"></div>
<div class="dots"></div>
<div class="dots"></div>
</div>
</div>
</div>
<div class="sidebar">
<div class="sidebar-content">
<div class="logo"><a href="../../page_0.html"><img alt="" src="../../images/logo_redash.png" srcset=""/></a></div>
<ul class="sidebar-grid">
<!-- <li><a href="#"><i class="fas fa-list-ul"></i> Topics</a></li> -->
<li><a href="../../page_0.html"><i class="fas fa-layer-group"></i> Topics</a></li>
<li><a href="../../users.html"><i class="fas fa-users"></i> Users</a></li>
<li><a href="../../about.html"><i class="fas fa-info-circle"></i> About</a></li>
<li><a href="../../faq.html"><i class="fas fa-question-circle"></i> FAQ</a></li>
<li><a href="../../groups.html"><i class="fas fa-users"></i> Groups</a></li>
<li><a href="../../badges.html"><i class="fas fa-certificate"></i> Badges</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#categories"><span>▼</span>Categories</a></h3>
<hr/>
<ul class="sidebar-grid categories">
<li>
<a class="badge-wrapper bullet" href="../../c/support/6.html">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name">Support</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/feature-requests/5.html">
<span class="badge-category-bg" style="background-color: #3AB54A"></span>
<span class="badge-category clear-badge">
<span class="category-name">Feature Requests</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/uncategorized/1.html">
<span class="badge-category-bg" style="background-color: #AB9364"></span>
<span class="badge-category clear-badge">
<span class="category-name">Uncategorized</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/development/7.html">
<span class="badge-category-bg" style="background-color: #8C6238"></span>
<span class="badge-category clear-badge">
<span class="category-name">Development</span>
</span>
</a>
</li>
<li>
<a class="badge-wrapper bullet" href="../../c/tips-tricks-query-examples/11.html">
<span class="badge-category-bg" style="background-color: #652D90"></span>
<span class="badge-category clear-badge" style="white-space: normal;">
<span class="category-name">Tips, Tricks &amp; Query Examples</span>
</span>
</a>
</li>
<li><a href="../../categories.html"><i class="fas fa-list-ul"></i> All categories</a></li>
</ul>
<h3 style="font-size: 13px;"><a href="#tags"><span>▼</span>Tags</a></h3>
<hr/>
<ul class="sidebar-grid tags">
<li><a href="../../tag/query_results.html"><i class="fas fa-tag"></i> query_results</a></li>
<li><a href="../../tag/feature-request.html"><i class="fas fa-tag"></i> feature-request</a></li>
<li><a href="../../tag/parameters.html"><i class="fas fa-tag"></i> parameters</a></li>
<li><a href="../../tag/visualizations.html"><i class="fas fa-tag"></i> visualizations</a></li>
<li><a href="../../tag/alerts.html"><i class="fas fa-tag"></i> alerts</a></li>
<li><a href="../../tags.html"><i class="fas fa-list-ul"></i> All tags</a></li>
</ul>
</div>
<div class="sidebar-footer">
            © 2023 <a href="https://discuss.redash.io/" target="_blank">discuss.redash.io</a>
</div>
</div>
<div class="overlay"></div>
<div class="content">
<div class="global-notice">
<div class="row">
<div class="alert alert-info alert-read-only" id="global-notice-alert-read-only">
<span class="text">This site is in read only mode. Please continue to browse, but replying, likes,
                        and other actions are disabled for now.</span>
</div>
</div>
</div>
<div class="imported_page" id="imported_page">
<div class="wrap" id="main-outlet" role="main">
<div id="topic-title">
<h1>
<a href="/t/altering-slow-athena-result-fetching-implementation/5634">Altering slow athena result fetching implementation</a>
</h1>
<div class="topic-category" itemscope="" itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
<a class="badge-wrapper bullet" href="../../c/development/7.html" itemprop="item">
<span class="badge-category-bg" style="background-color: #8C6238"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Development</span>
</span>
</a>
<meta content="1" itemprop="position"/>
</span>
</div>
</div>
<div itemscope="" itemtype="http://schema.org/DiscussionForumPosting">
<meta content="Altering slow athena result fetching implementation" itemprop="headline"/>
<meta content="Development" itemprop="articleSection"/>
<meta content="" itemprop="keywords"/>
<div itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
<meta content="Redash Discourse" itemprop="name"/>
<div itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject">
<meta content="https://global.discourse-cdn.com/standard17/uploads/redash1/original/1X/c07bc573841e1e4a0013ea3b6fe088a1534228a3.png" itemprop="url"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_1">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/Shitij.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/Shitij_avatar.png" tabindex="-1" width="48"/><span itemprop="name">Shitij</span></a>
</span>
<link href="https://discuss.redash.io/t/altering-slow-athena-result-fetching-implementation/5634" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-02-25T16:45:29Z" itemprop="datePublished">
                    February 25, 2020,  4:45pm
                  </time>
<meta content="2020-02-28T11:28:04Z" itemprop="dateModified"/>
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>Hi,<br/>
I am using athena with Redash and found that it is pretty slow for bigger queries. ~20 lac rows</p>
<p>The query finished withing 2 minutes in athena but took more than 12-13 minutes in Redash to get the results. After looking at the code, i found that pyathena cursor is being used which I think may be the bottleneck, as it fetches results and serialises them into JSON. This has become a bit of a blocker at our side.</p>
<p>I’ve worked on an alternate implementation which involves transferring the CSV result file directly from Athena S3 to Redash machine and converting the records to json with python’s csv DictReader. It has improved the speed of fetching data to 2-3 minutes for the same query.</p>
<p><code>bucket, key = parse_output_location(cursor.output_location)</code><br/>
<code>s3 = boto3.client('s3', **self._get_iam_credentials(user=user))</code><br/>
<code>athena_query_results_file = athena_query_id</code><br/>
<code>with open(athena_query_results_file, 'wb') as w:</code><br/>
<code>s3.download_fileobj(bucket, key, w)</code><br/>
<code>with open(athena_query_results_file, 'r+') as f:</code><br/>
<code>rows = list(csv.DictReader(f))</code><br/>
Crux of the change</p>
<p>P.S - Should I create a PR or first get the idea reviewed here?</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_2" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/jesse.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/jesse_avatar.png" tabindex="-1" width="48"/><span itemprop="name">jesse</span></a>
</span>
<link href="https://discuss.redash.io/t/altering-slow-athena-result-fetching-implementation/5634" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-02-25T22:14:56Z" itemprop="datePublished">
                    February 25, 2020, 10:14pm
                  </time>
<meta content="2020-02-25T22:14:56Z" itemprop="dateModified"/>
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>How many rows are you returning?</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_3" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/Shitij.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/Shitij_avatar.png" tabindex="-1" width="48"/><span itemprop="name">Shitij</span></a>
</span>
<link href="https://discuss.redash.io/t/altering-slow-athena-result-fetching-implementation/5634" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-02-26T07:51:40Z" itemprop="datePublished">
                    February 26, 2020,  7:51am
                  </time>
<meta content="2020-02-26T07:51:40Z" itemprop="dateModified"/>
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Tried returning 1 lac, 10 lac, 20 lac rows. All queries in redash going over 10 minutes. While fetching the output file directly reduces it to 2 minutes.</p>
<p>I know redash is not meant for large datasets but there are some usecases where this is needed.<br/>
Running redash server on a EC2 machine</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_4" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/jesse.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/jesse_avatar.png" tabindex="-1" width="48"/><span itemprop="name">jesse</span></a>
</span>
<link href="https://discuss.redash.io/t/altering-slow-athena-result-fetching-implementation/5634" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-02-28T04:36:30Z" itemprop="datePublished">
                    February 28, 2020,  4:36am
                  </time>
<meta content="2020-02-28T04:36:30Z" itemprop="dateModified"/>
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-post="3" data-topic="5634" data-username="Shitij">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="assets/1834_2.png" width="20"/> Shitij:</div>
<blockquote>
<p>I know redash is not meant for large datasets</p>
</blockquote>
</aside>
<p>Correct.</p>
<aside class="quote no-group" data-post="3" data-topic="5634" data-username="Shitij">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="assets/1834_2.png" width="20"/> Shitij:</div>
<blockquote>
<p>but there are some usecases where this is needed.</p>
</blockquote>
</aside>
<p>Then use other tools. Redash works best with results under 20mb. It’s a visualization tool, not a big data platform.  100k rows is well outside our scope.</p>
<p>The delay with the query runner is serialization of all that data into JSON. As you found…</p>
<aside class="quote no-group" data-post="1" data-topic="5634" data-username="Shitij">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="assets/1834_2.png" width="20"/> Shitij:</div>
<blockquote>
<p>i found that pyathena cursor is being used which I think may be the bottleneck, as it fetches results and serialises them into JSON. This has become a bit of a blocker at our side</p>
</blockquote>
</aside>
<p>This is expected behavior for Redash. Not a bug.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_5" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/Shitij.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/Shitij_avatar.png" tabindex="-1" width="48"/><span itemprop="name">Shitij</span></a>
</span>
<link href="https://discuss.redash.io/t/altering-slow-athena-result-fetching-implementation/5634" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-02-28T06:00:13Z" itemprop="datePublished">
                    February 28, 2020,  6:00am
                  </time>
<meta content="2020-02-28T06:10:01Z" itemprop="dateModified"/>
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p>But even if we discard the big results issue, won’t it be beneficial to have an implementation which is faster in any case? I fail to see how slow serialization of data is a feature. I would happily create a PR for my implementation but wanted to get the community’s views on whether it would be worthwhile.</p>
<p>Also practically speaking, its sometimes hard to enforce this on the people making queries. We are not stopping the user from getting big data into redash, it’s just a best practice. Why not improve the implementation and let people who query decide what’s best for them? Only point being that if it is a matter of 10 rows or 10k rows, we can have a more efficient system with minimal changes</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_6" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/jesse.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/jesse_avatar.png" tabindex="-1" width="48"/><span itemprop="name">jesse</span></a>
</span>
<link href="https://discuss.redash.io/t/altering-slow-athena-result-fetching-implementation/5634" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-02-28T11:26:59Z" itemprop="datePublished">
                    February 28, 2020, 11:26am
                  </time>
<meta content="2020-02-28T11:26:59Z" itemprop="dateModified"/>
<span itemprop="position">6</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-post="5" data-topic="5634" data-username="Shitij">
<div class="title">
<div class="quote-controls"></div>
<img alt="" class="avatar" height="20" src="assets/1834_2.png" width="20"/> Shitij:</div>
<blockquote>
<p>won’t it be beneficial to have an implementation which is faster in any case?</p>
</blockquote>
</aside>
<p><img alt=":+1:t2:" class="emoji only-emoji" src="assets/2.png" title=":+1:t2:"/></p>
<p>Sorry I was unclear. I meant that we can’t avoid serialization altogether even though it takes longer for large results.</p>
<p>Also, we don’t exclude users with big data sets. Its browser performance that gets in the way. The tab crashes when someone charts 100k+ rows. Your proposal means that person will wait 2 minutes instead of 10 minutes <img alt=":100:" class="emoji" src="assets/100.png" title=":100:"/>, but the app will crash anyway <img alt=":no_mouth:" class="emoji" src="assets/no_mouth.png" title=":no_mouth:"/></p>
<p>For reference, we know that 95% of queries in Redash (SaaS) execute within 10 seconds. If you can make that faster, by all means do so. But I’d hate for you to invest much time before you realize why Redash was the wrong tool for your needs.</p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
<div class="topic-body crawler-post" id="post_7" itemprop="comment" itemscope="" itemtype="http://schema.org/Comment">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a href="../../u/detail/Shitij.html" itemprop="url"><img alt="" class="avatar" height="48" loading="lazy" src="../../u/avatars/Shitij_avatar.png" tabindex="-1" width="48"/><span itemprop="name">Shitij</span></a>
</span>
<link href="https://discuss.redash.io/t/altering-slow-athena-result-fetching-implementation/5634" itemprop="mainEntityOfPage"/>
<span class="crawler-post-infos">
<time class="post-time" datetime="2020-03-04T16:01:33Z" itemprop="datePublished">
                    March 4, 2020,  4:01pm
                  </time>
<meta content="2020-03-04T16:01:33Z" itemprop="dateModified"/>
<span itemprop="position">7</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Thanks susodapop for clarifying.<br/>
Got your point and I agree with you.<br/>
I had to change the implementation in a redash fork for my company for unavoidable reasons. But I believe it will improve the time for regular short athena queries too. In my experiments a query showing 10-15 seconds on redash, got reduced to around 5-6 seconds (depending on the result count). Not a massive diff yes, but still I think it will improve the user experience.<br/>
As this is my first foray in open source, very thankful for helping me understand this. I would like to create a PR for this optimization. <img alt=":slight_smile:" class="emoji" src="assets/slight_smile.png" title=":slight_smile:"/></p>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/LikeAction" itemprop="interactionType"/>
<meta content="1" itemprop="userInteractionCount"/>
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope="" itemtype="http://schema.org/InteractionCounter">
<meta content="http://schema.org/CommentAction" itemprop="interactionType"/>
<meta content="0" itemprop="userInteractionCount"/>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="overlay" id="modalOverlay" style="display: none;">
<div class="modal-content">
<p>Login or sign up disabled while the site is in read only mode</p>
<hr/>
<button class="btn btn-login">OK</button>
</div>
</div>
<script src="../../js/script.js"></script>
</body>
</html>